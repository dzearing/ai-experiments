---
phase: 04-hover-toolbar
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - react-chat/src/components/ChatMessage/ChatMessage.tsx
  - react-chat/src/components/ChatMessage/ChatMessage.module.css
autonomous: true

must_haves:
  truths:
    - "Toolbar appears on message hover in top-right corner"
    - "Toolbar displays formatted timestamp"
    - "Copy button copies message text content to clipboard"
    - "Edit button visible only when enableEdit prop is true"
  artifacts:
    - path: "react-chat/src/components/ChatMessage/ChatMessage.tsx"
      provides: "MessageToolbar integration with ChatMessage"
      contains: "MessageToolbar"
    - path: "react-chat/src/components/ChatMessage/ChatMessage.module.css"
      provides: "Hover reveal styles for toolbar"
      contains: ":hover .messageToolbar"
  key_links:
    - from: "ChatMessage.tsx"
      to: "MessageToolbar"
      via: "import and render"
      pattern: "import.*MessageToolbar"
    - from: "ChatMessage.tsx"
      to: "getContent callback"
      via: "extractTextContent helper"
      pattern: "getContent.*extractTextContent"
---

<objective>
Integrate MessageToolbar into ChatMessage with copy and edit actions

Purpose: Wire up the MessageToolbar component to ChatMessage so users can see timestamp and perform actions (copy, edit) on hover. This completes all TBR requirements.

Output: ChatMessage displays toolbar on hover with working copy and optional edit functionality
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-hover-toolbar/04-RESEARCH.md
@.planning/phases/04-hover-toolbar/04-01-SUMMARY.md

# Current ChatMessage implementation
@react-chat/src/components/ChatMessage/ChatMessage.tsx
@react-chat/src/components/ChatMessage/ChatMessage.module.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hover reveal CSS for MessageToolbar</name>
  <files>
    react-chat/src/components/ChatMessage/ChatMessage.module.css
  </files>
  <action>
Add CSS rules to show MessageToolbar on message hover:

1. Add .messageToolbar class (positioned absolute, initially opacity: 0)
2. Add hover/focus-within reveal rules for both 1-on-1 and group modes:

```css
/* Message toolbar positioning (component provides its own surface styling) */
.messageToolbar {
  position: absolute;
  right: var(--space-2);
  top: var(--space-2);
  opacity: 0;
  transition: opacity var(--duration-fast) var(--ease-default);
  z-index: 1;
}

/* Show toolbar on hover or focus-within for both modes */
.oneOnOneMessage:hover .messageToolbar,
.oneOnOneMessage:focus-within .messageToolbar,
.groupMessage:hover .messageToolbar,
.groupMessage:focus-within .messageToolbar {
  opacity: 1;
}
```

3. Ensure .oneOnOneMessage and .groupMessage have position: relative (already set for groupMessage, add to oneOnOneMessage if missing)
  </action>
  <verify>
- CSS file contains .messageToolbar class
- CSS file contains hover/focus-within reveal rules
- Run: cd /Users/dzearing/git/ai-exp-2/packages/ui-kit && pnpm build
  </verify>
  <done>
CSS added for toolbar positioning and hover reveal in both modes
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate MessageToolbar into ChatMessage component</name>
  <files>
    react-chat/src/components/ChatMessage/ChatMessage.tsx
  </files>
  <action>
Update ChatMessage to render MessageToolbar on messages:

1. Import MessageToolbar from '../MessageToolbar'

2. Add new props to ChatMessageProps interface:
```typescript
/** Callback when edit is clicked on toolbar */
onEdit?: (messageId: string) => void;
/** Enable edit button in toolbar (default: false) */
enableEdit?: boolean;
```

3. Create extractTextContent helper function to get plain text from message parts:
```typescript
function extractTextContent(parts: ChatMessagePart[]): string {
  return parts
    .filter((p): p is ChatMessageTextPart => p.type === 'text')
    .map(p => p.text)
    .join('\n');
}
```

4. In the component body, create getContent callback:
```typescript
const getContent = useCallback(() => {
  return extractTextContent(messageParts);
}, [messageParts]);
```

5. Create handleEdit callback:
```typescript
const handleEdit = useCallback(() => {
  onEdit?.(id);
}, [onEdit, id]);
```

6. Render MessageToolbar inside both 1-on-1 and group mode JSX:
- Place at the start of the message container (before content)
- Pass: timestamp, getContent, isOwn, showEdit={enableEdit}, onEdit={handleEdit}
- Apply styles.messageToolbar className

For 1-on-1 mode (inside the .oneOnOneMessage div):
```tsx
<MessageToolbar
  timestamp={timestamp}
  getContent={getContent}
  isOwn={isOwn}
  showEdit={enableEdit}
  onEdit={handleEdit}
  className={styles.messageToolbar}
/>
```

For group mode (inside the .groupMessage div, before avatar):
```tsx
<MessageToolbar
  timestamp={timestamp}
  getContent={getContent}
  isOwn={isOwn}
  showEdit={enableEdit}
  onEdit={handleEdit}
  className={styles.messageToolbar}
/>
```

7. Update arePropsEqual memo comparison to include onEdit and enableEdit

8. Remove the underscore prefixes from menuItems and onMenuSelect props if they were reserved - they're now replaced by enableEdit and onEdit
  </action>
  <verify>
- Run: cd /Users/dzearing/git/ai-exp-2/packages/ui-kit && pnpm build
- Build passes without errors
- ChatMessage renders MessageToolbar in both modes
  </verify>
  <done>
ChatMessage integrates MessageToolbar with:
- extractTextContent helper for copy functionality
- enableEdit and onEdit props for edit action
- Toolbar rendered in both 1-on-1 and group modes
- Build passes without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify toolbar functionality in Storybook</name>
  <files>
    react-chat/src/components/ChatMessage/ChatMessage.stories.tsx
  </files>
  <action>
Update or create Storybook stories to demonstrate toolbar:

1. Check existing stories - add hover state demonstration if not present

2. Add story for edit-enabled message:
```tsx
export const WithEditEnabled: Story = {
  args: {
    id: 'msg-1',
    content: 'This message has edit enabled. Hover to see toolbar.',
    timestamp: new Date(),
    senderName: 'User',
    isOwn: true,
    enableEdit: true,
    onEdit: (messageId) => console.log('Edit clicked:', messageId),
  },
};
```

3. Add story showing toolbar on assistant message (different styling):
```tsx
export const AssistantWithToolbar: Story = {
  args: {
    id: 'msg-2',
    content: 'This is an assistant message. Hover to see the toolbar with different styling.',
    timestamp: new Date(),
    senderName: 'Assistant',
    isOwn: false,
  },
};
```

If stories already exist and cover these cases, just verify they work with the new toolbar.
  </action>
  <verify>
- Run Storybook: cd /Users/dzearing/git/ai-exp-2/packages/ui-kit/react-chat && pnpm storybook (if available)
- Or verify stories compile: pnpm build
- Stories demonstrate toolbar on hover
  </verify>
  <done>
Storybook stories updated to demonstrate toolbar functionality:
- Toolbar visible on hover
- Edit button visible when enableEdit=true
- Different styling for user vs assistant messages
  </done>
</task>

</tasks>

<verification>
1. Build passes: `cd /Users/dzearing/git/ai-exp-2/packages/ui-kit && pnpm build`
2. Hover over message in Storybook shows toolbar in top-right
3. Toolbar displays formatted timestamp
4. Copy button works (copies message text)
5. Edit button appears only when enableEdit=true
6. Toolbar has user styling on user messages, assistant styling on assistant messages
</verification>

<success_criteria>
- TBR-01: Toolbar appears on message hover in top-right corner
- TBR-02: Toolbar displays formatted timestamp
- TBR-03: Copy button copies message content to clipboard
- TBR-04: Edit button is configurable (enableEdit prop, off by default)
- TBR-05: Toolbar styling adapts to message type (user vs assistant)
- TBR-06: Toolbar has backdrop blur for visual separation
- All requirements verified through Storybook or manual testing
</success_criteria>

<output>
After completion, create `.planning/phases/04-hover-toolbar/04-02-SUMMARY.md`
</output>
