---
phase: 06-extended-tools
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/claude-code-web/client/src/hooks/useConversation.ts
  - apps/claude-code-web/client/src/components/ChatView.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Multi-line user messages display correctly in chat"
    - "User messages with newlines show actual content, not blank"
    - "Whitespace in user input is preserved"
  artifacts:
    - path: "apps/claude-code-web/client/src/hooks/useConversation.ts"
      provides: "User message creation with proper text handling"
      contains: "parts.*text.*prompt"
    - path: "apps/claude-code-web/client/src/components/ChatView.tsx"
      provides: "Chat rendering that preserves whitespace"
  key_links:
    - from: "useConversation.ts"
      to: "ChatView.tsx"
      via: "messages prop"
      pattern: "messages"
---

<objective>
Fix multi-line user input showing blank in chat bubbles.

Purpose: Users reported that when typing multi-line prompts (with newlines), the message bubble shows blank even though the message was sent correctly. This degrades UX.

Output: Multi-line user messages display correctly with preserved newlines.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-extended-tools/06-UAT.md

Relevant source files:
@apps/claude-code-web/client/src/hooks/useConversation.ts
@apps/claude-code-web/client/src/components/ChatView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Debug and fix multi-line text display</name>
  <files>
    apps/claude-code-web/client/src/hooks/useConversation.ts
    apps/claude-code-web/client/src/components/ChatView.tsx
  </files>
  <action>
First, investigate the issue:

1. In useConversation.ts line 72, check how user messages are created:
```typescript
parts: [{ type: 'text', text: prompt }],
```
This looks correct - the prompt text should be passed as-is.

2. Check if the issue is in ChatView.tsx when trimming input:
```typescript
if (data.content.trim()) {
  sendMessage(data.content.trim());
}
```
`trim()` removes leading/trailing whitespace but should preserve internal newlines. However, `trim()` is called BEFORE the message is sent - this is correct.

3. The issue might be in the ChatInput component or MarkdownRenderer. Check:
   - Does MarkdownRenderer handle text with only newlines (no other content)?
   - Is there CSS that collapses whitespace?

Likely causes to investigate:
- The `content: ''` field being set empty while parts has the text
- MarkdownRenderer collapsing whitespace
- CSS `white-space: nowrap` or similar

Debug approach:
1. Add console.log in sendMessage to verify prompt content
2. Check if ChatPanel uses `content` field or `parts` field for display
3. Look at ChatMessage rendering in @ui-kit/react-chat

Fix approach based on investigation:
- If ChatPanel uses `content` field: set `content: prompt` alongside parts
- If whitespace issue: ensure renderMarkdown handles newlines
- If CSS issue: add `white-space: pre-wrap` to message content

Most likely fix: The ChatMessage component might be using the `content` field when parts contain only text. Update useConversation.ts:

```typescript
const userMsg: ChatPanelMessage = {
  id: `user-${Date.now()}`,
  content: prompt,  // Set content to prompt text (not empty string)
  parts: [{ type: 'text', text: prompt }],
  timestamp: new Date(),
  senderName: 'You',
  isOwn: true,
  renderMarkdown: true,
};
```

The `content` field was set to empty string `''` with comment "Use parts instead", but the ChatPanel may fall back to `content` when parts contain only simple text.
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no type errors
2. Manual test: Type a multi-line message (with Enter/newlines) and send - verify it displays with newlines preserved
  </verify>
  <done>Multi-line user messages display correctly with newlines visible</done>
</task>

<task type="auto">
  <name>Task 2: Ensure whitespace preservation in CSS</name>
  <files>apps/claude-code-web/client/src/components/ChatView.module.css</files>
  <action>
If the issue persists after Task 1, check and fix CSS whitespace handling.

1. Check if ChatView.module.css has any whitespace-collapsing styles
2. The chat message content should use `white-space: pre-wrap` or `pre-line` to preserve newlines

If needed, add CSS override in ChatView.module.css:

```css
/* Ensure multi-line messages preserve whitespace */
.chatPanel :global(.chat-message-content) {
  white-space: pre-wrap;
}
```

Note: The actual class name depends on what @ui-kit/react-chat uses internally. May need to inspect the rendered DOM or check the ui-kit source.

Alternative: If the ui-kit ChatMessage already handles whitespace correctly, this task may not be needed. The primary fix is likely in Task 1.
  </action>
  <verify>
1. Build client: `pnpm build` in apps/claude-code-web/client
2. Manual test: Verify newlines display correctly in the chat bubble
  </verify>
  <done>CSS does not collapse whitespace in user messages</done>
</task>

</tasks>

<verification>
After implementation:
1. TypeScript compiles without errors
2. Client builds successfully
3. Type a message with multiple lines (press Enter between lines)
4. Send the message
5. The chat bubble should show all lines with proper line breaks
</verification>

<success_criteria>
- Multi-line user input displays with preserved newlines
- Empty lines within the message are preserved
- Message bubble is not blank for multi-line content
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-extended-tools/06-06-SUMMARY.md`
</output>
