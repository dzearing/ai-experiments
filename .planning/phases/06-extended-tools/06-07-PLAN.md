---
phase: 06-extended-tools
plan: 07
type: execute
wave: 2
depends_on: [06-05]
files_modified:
  - apps/claude-code-web/client/src/hooks/useAgentStream.ts
  - apps/claude-code-web/client/src/types/agent.ts
  - apps/claude-code-web/client/src/components/ToolExecutionIndicator.tsx
  - apps/claude-code-web/client/src/components/ToolExecutionIndicator.module.css
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Permission timeout shows error feedback to user"
    - "Failed tools show error state instead of infinite spinner"
    - "Error reason is visible in the UI"
  artifacts:
    - path: "apps/claude-code-web/client/src/hooks/useAgentStream.ts"
      provides: "Error tracking for tool failures"
      contains: "is_error"
    - path: "apps/claude-code-web/client/src/components/ToolExecutionIndicator.tsx"
      provides: "Error state display"
      contains: "error"
  key_links:
    - from: "useAgentStream.ts"
      to: "ToolExecutionIndicator.tsx"
      via: "tool error state"
      pattern: "error.*tool"
---

<objective>
Show error feedback when permission times out or tool execution fails.

Purpose: Currently when a permission request times out (55s), the user sees no feedback - tools just keep spinning indefinitely. Users need to know when something failed so they can take action.

Output: Permission timeouts and tool errors display visible error state in the UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-extended-tools/06-UAT.md
@.planning/phases/06-extended-tools/06-05-SUMMARY.md

Relevant source files:
@apps/claude-code-web/client/src/hooks/useAgentStream.ts
@apps/claude-code-web/client/src/types/agent.ts
@apps/claude-code-web/client/src/components/ToolExecutionIndicator.tsx
@apps/claude-code-web/server/src/services/permissionService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track tool errors in message state</name>
  <files>
    apps/claude-code-web/client/src/types/agent.ts
    apps/claude-code-web/client/src/hooks/useAgentStream.ts
  </files>
  <action>
The SDK's tool_result blocks have an `is_error` field indicating if the tool failed. We need to:
1. Capture this error state when processing tool results
2. Surface it to the UI components

**In agent.ts:**

The ToolResultBlock already has `is_error?: boolean` from Plan 06-05.

**In useAgentStream.ts:**

1. When processing tool results (from Plan 06-05), check for `is_error`:

```typescript
if (result) {
  call.completed = true;
  call.output = result.content;
  call.endTime = Date.now();

  // Track error state - permission timeouts and tool failures
  if (result.is_error) {
    call.error = result.content;  // Error message in content
    call.cancelled = true;  // Mark as cancelled/failed
  }
}
```

Note: ChatMessageToolCall has `cancelled?: boolean` which we can repurpose for error state, or we can add an `error?: string` field.

2. Check the ChatMessageToolCall interface in @ui-kit/react-chat:
   - It has `cancelled?: boolean` but may not have `error?: string`
   - If no error field exists, store error message in output and use cancelled as error flag

3. When a permission is denied (from respondToPermission), we already track it in deniedPermissions. But tool_result with is_error=true is different - it means the tool execution itself failed.

The flow for permission timeout:
- permissionService.ts resolves with `{ behavior: 'deny', message: 'Permission request timed out' }`
- SDK receives denial and sends tool_result with is_error=true
- We process this tool_result and mark the tool call as completed with error

So the fix from Plan 06-05 should handle this IF we properly set error state based on is_error.
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no type errors
2. Check that tool_result processing includes is_error handling
  </verify>
  <done>Tool errors are tracked in message state with is_error flag</done>
</task>

<task type="auto">
  <name>Task 2: Display error state in ToolExecutionIndicator</name>
  <files>
    apps/claude-code-web/client/src/components/ToolExecutionIndicator.tsx
    apps/claude-code-web/client/src/components/ToolExecutionIndicator.module.css
  </files>
  <action>
Update ToolExecutionIndicator to show error state when a tool fails.

**In ToolExecutionIndicator.tsx:**

1. Add `isError` and `errorMessage` props:

```typescript
export interface ToolExecutionIndicatorProps {
  toolName: string;
  isExecuting: boolean;
  isError?: boolean;
  errorMessage?: string;
}
```

2. Update the component to show error state:

```typescript
export function ToolExecutionIndicator({
  toolName,
  isExecuting,
  isError = false,
  errorMessage,
}: ToolExecutionIndicatorProps) {
  if (isError) {
    return (
      <div className={styles.errorContainer}>
        <AlertCircleIcon size={16} className={styles.errorIcon} />
        <span className={styles.errorText}>
          {toolName} failed
          {errorMessage && `: ${errorMessage}`}
        </span>
      </div>
    );
  }

  // ... existing executing state code
}
```

3. Import AlertCircleIcon from @ui-kit-icons (or use a similar icon).

**In ToolExecutionIndicator.module.css:**

Add error state styles:

```css
.errorContainer {
  display: flex;
  align-items: center;
  gap: var(--spacing-small10);
  padding: var(--spacing-small10);
  background: var(--color-danger-backgroundSubtle);
  border-radius: var(--radius-small);
}

.errorIcon {
  color: var(--color-danger-text);
  flex-shrink: 0;
}

.errorText {
  color: var(--color-danger-text);
  font-size: var(--font-size-small);
}
```

Note: Check available design tokens. If danger tokens don't exist, use appropriate error coloring from the token system.
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no type errors
2. Build client: `pnpm build` in apps/claude-code-web/client
  </verify>
  <done>ToolExecutionIndicator displays error state with icon and message</done>
</task>

<task type="auto">
  <name>Task 3: Wire error state through ToolResultDisplay</name>
  <files>apps/claude-code-web/client/src/components/ToolResultDisplay.tsx</files>
  <action>
Update ToolResultDisplay to pass error state to ToolExecutionIndicator.

1. Add `isError` and `errorMessage` to ToolResultDisplayProps:

```typescript
export interface ToolResultDisplayProps {
  toolName: string;
  input: Record<string, unknown>;
  output: string;
  isExpanded: boolean;
  isExecuting?: boolean;
  isError?: boolean;
  errorMessage?: string;
  onToggleExpand: () => void;
  onFileClick?: (path: string, line?: number) => void;
}
```

2. Update the execution indicator section (around line 103):

```typescript
// Show error indicator if tool failed
if (isError) {
  return <ToolExecutionIndicator toolName={toolName} isExecuting={false} isError={true} errorMessage={errorMessage} />;
}

// Show execution indicator if tool is still running
if (isExecuting) {
  return <ToolExecutionIndicator toolName={toolName} isExecuting={true} />;
}
```

3. Now we need to propagate isError from the ChatPanelMessage through ChatPanel's renderToolResult.

Check how ChatPanel calls renderToolResult - it passes props from the tool call. We need ChatMessageToolCall to have error info.

Since ChatMessageToolCall has `cancelled?: boolean`, we can use that as the error flag:
- `cancelled: true` + output contains error message = error state
- Pass output as errorMessage when cancelled

In ChatView.tsx, update renderToolResult:

```typescript
const renderToolResult = useCallback((props: {
  toolName: string;
  input: Record<string, unknown>;
  output: string;
  isExpanded: boolean;
  onToggleExpand: () => void;
  completed?: boolean;
  cancelled?: boolean;  // This indicates error
}) => {
  return (
    <ToolResultDisplay
      toolName={props.toolName}
      input={props.input}
      output={props.output}
      isExpanded={props.isExpanded}
      onToggleExpand={props.onToggleExpand}
      isExecuting={!props.completed && !props.cancelled}
      isError={props.cancelled}
      errorMessage={props.cancelled ? props.output : undefined}
    />
  );
}, []);
```

Note: Check what props ChatPanel actually passes to renderToolResult. It may include completed and cancelled from ChatMessageToolCall.
  </action>
  <verify>
1. Run `npx tsc --noEmit` - no type errors
2. Build client: `pnpm build` in apps/claude-code-web/client
3. Manual test: Let a permission time out (wait 55s) - should see error instead of spinner
  </verify>
  <done>Error state is wired from tool call through to display component</done>
</task>

</tasks>

<verification>
After implementation:
1. TypeScript compiles without errors
2. Client builds successfully
3. When a permission times out:
   - User sees error indicator with "Permission request timed out" message
   - No more infinite spinner
4. When SDK sends tool_result with is_error=true:
   - Tool shows error state with error message
</verification>

<success_criteria>
- Permission timeout (55s) shows visible error feedback
- Tool execution errors show error state instead of spinner
- Error messages are displayed to user
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-extended-tools/06-07-SUMMARY.md`
</output>
