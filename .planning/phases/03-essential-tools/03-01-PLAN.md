---
phase: 03-essential-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/claude-code-web/server/src/routes/files.ts
  - apps/claude-code-web/server/src/services/fileService.ts
  - apps/claude-code-web/server/src/index.ts
  - apps/claude-code-web/client/src/utils/toolResultTransformers.ts
  - apps/claude-code-web/client/src/utils/languageDetection.ts
autonomous: true

must_haves:
  truths:
    - "Server provides file read endpoint with path security validation"
    - "Server provides directory listing endpoint"
    - "Tool output parsers transform SDK output to display-friendly format"
    - "Language detection maps file extensions to Prism languages"
  artifacts:
    - path: "apps/claude-code-web/server/src/routes/files.ts"
      provides: "File read and list endpoints"
      exports: ["router"]
    - path: "apps/claude-code-web/server/src/services/fileService.ts"
      provides: "File operations with security validation"
      exports: ["readFile", "listDirectory", "isPathSafe"]
    - path: "apps/claude-code-web/client/src/utils/toolResultTransformers.ts"
      provides: "Glob and Grep output parsers"
      exports: ["parseGlobOutput", "parseGrepOutput"]
    - path: "apps/claude-code-web/client/src/utils/languageDetection.ts"
      provides: "File extension to Prism language mapping"
      exports: ["detectLanguage"]
  key_links:
    - from: "apps/claude-code-web/server/src/index.ts"
      to: "apps/claude-code-web/server/src/routes/files.ts"
      via: "Express router mount"
      pattern: "app\\.use.*files"
    - from: "apps/claude-code-web/server/src/routes/files.ts"
      to: "apps/claude-code-web/server/src/services/fileService.ts"
      via: "Service import"
      pattern: "import.*fileService"
---

<objective>
Create the foundation for tool visualization: server file API and client-side tool output transformers.

Purpose: Provide the infrastructure that tool result components need - file read/list endpoints on server, and parsing utilities on client to transform SDK tool output into display-friendly formats.

Output: Server /api/files endpoints for read and list operations, plus client utilities for parsing Glob/Grep output and detecting languages from file extensions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-essential-tools/03-RESEARCH.md

# Prior work
@.planning/phases/02-core-streaming/02-01-SUMMARY.md
@.planning/phases/02-core-streaming/02-02-SUMMARY.md

# Existing patterns
@apps/claude-code-web/server/src/routes/agent.ts
@apps/claude-code-web/server/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create file service with security validation</name>
  <files>apps/claude-code-web/server/src/services/fileService.ts</files>
  <action>
Create a file service module that provides secure file operations:

1. `isPathSafe(requestedPath: string, cwd: string): boolean` - Validates that resolved path stays within cwd
2. `readFile(filePath: string, cwd: string): Promise<FileReadResult>` - Reads file content with metadata
3. `listDirectory(dirPath: string, cwd: string): Promise<DirectoryEntry[]>` - Lists directory contents

Types to define:
- `FileReadResult: { path: string; content: string; size: number; lines: number }`
- `DirectoryEntry: { name: string; type: 'file' | 'directory'; size?: number }`

Security: All paths resolved relative to cwd using path.resolve(). Return 403 error if path escapes cwd.
Use fs/promises for async file operations.
  </action>
  <verify>TypeScript compiles without errors: `cd apps/claude-code-web/server && pnpm build`</verify>
  <done>fileService.ts exports readFile, listDirectory, and isPathSafe functions with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Create file routes and wire to Express</name>
  <files>apps/claude-code-web/server/src/routes/files.ts, apps/claude-code-web/server/src/index.ts</files>
  <action>
Create Express router for file operations:

1. In files.ts:
   - `GET /read?path=<filepath>` - Returns file content with metadata using fileService.readFile
   - `GET /list?path=<dirpath>` - Returns directory listing using fileService.listDirectory
   - Decode path from query string with decodeURIComponent
   - Use process.cwd() as the working directory for now
   - Return appropriate HTTP status codes: 200 success, 403 path outside cwd, 404 not found, 500 server error

2. In index.ts:
   - Import and mount the files router at `/api/files`
   - Follow existing pattern from agent router
  </action>
  <verify>
Server builds: `cd apps/claude-code-web/server && pnpm build`
Test endpoints manually:
- `curl "http://localhost:3002/api/files/read?path=package.json"` returns file content
- `curl "http://localhost:3002/api/files/list?path=."` returns directory listing
  </verify>
  <done>Server exposes /api/files/read and /api/files/list endpoints with proper security validation</done>
</task>

<task type="auto">
  <name>Task 3: Create client-side tool transformers and language detection</name>
  <files>apps/claude-code-web/client/src/utils/toolResultTransformers.ts, apps/claude-code-web/client/src/utils/languageDetection.ts</files>
  <action>
Create utility modules for parsing tool output:

1. In languageDetection.ts:
   - Export `detectLanguage(filePath: string): string`
   - Map common extensions to Prism language names
   - Cover: js, jsx, ts, tsx, mjs, cjs, html, css, scss, json, py, rb, go, rs, java, c, cpp, cs, yaml, yml, toml, md, sh, bash, zsh, sql, graphql
   - Return 'plaintext' for unknown extensions

2. In toolResultTransformers.ts:
   - Export `parseGlobOutput(output: string): GlobResult`
     - GlobResult: { files: string[]; truncated: boolean; totalCount: number }
     - Parse line-by-line, detect truncation message "... and N more files"
   - Export `parseGrepOutput(output: string): GrepResult`
     - GrepMatch: { file: string; line: number; content: string }
     - GrepResult: { matches: GrepMatch[]; truncated: boolean; totalMatches: number }
     - Parse format "file:line:content" or "file:line-content"

Handle edge cases: empty output, malformed lines, missing line numbers.
  </action>
  <verify>TypeScript compiles: `cd apps/claude-code-web/client && pnpm build`</verify>
  <done>Client has languageDetection.ts and toolResultTransformers.ts utilities ready for use by tool result components</done>
</task>

</tasks>

<verification>
1. Server builds without errors
2. Client builds without errors
3. Server file endpoints respond correctly (manual curl test)
4. No TypeScript errors in either package
</verification>

<success_criteria>
- Server /api/files/read endpoint returns file content with 200, 403, or 404 as appropriate
- Server /api/files/list endpoint returns directory entries
- Path security validation prevents access outside working directory
- Client utilities parse Glob/Grep output formats correctly
- Language detection covers common file types with plaintext fallback
</success_criteria>

<output>
After completion, create `.planning/phases/03-essential-tools/03-01-SUMMARY.md`
</output>
