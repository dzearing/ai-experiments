# Plan 01-01: Server Scaffolding with Express and Agent SDK

**Phase**: 01 - Infrastructure Foundation
**Estimated complexity**: Medium

## Goal

Create a TypeScript Express v5 server with health endpoint and Agent SDK initialization that starts and responds to requests.

## Tasks

### Task 1: Create server package structure

**Files**:
- `apps/claude-code-web/server/package.json`
- `apps/claude-code-web/server/tsconfig.json`

**Action**: Create

Create the server package with proper ESM configuration:

**package.json:**
```json
{
  "name": "@claude-code-web/server",
  "version": "0.0.1",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "typecheck": "tsc --noEmit"
  },
  "dependencies": {
    "@anthropic-ai/claude-agent-sdk": "^0.2.12",
    "cors": "^2.8.5",
    "dotenv": "^17.0.1",
    "express": "^5.1.0",
    "uuid": "^11.1.0"
  },
  "devDependencies": {
    "@types/cors": "^2.8.0",
    "@types/express": "^5.0.0",
    "@types/node": "^24.0.0",
    "@types/uuid": "^10.0.0",
    "tsx": "^4.20.3",
    "typescript": "~5.8.3"
  }
}
```

**tsconfig.json:**
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "NodeNext",
    "moduleResolution": "NodeNext",
    "esModuleInterop": true,
    "strict": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "isolatedModules": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### Task 2: Create Express server entry point with health endpoint

**Files**:
- `apps/claude-code-web/server/src/index.ts`
- `apps/claude-code-web/server/src/routes/health.ts`

**Action**: Create

**src/routes/health.ts:**
```typescript
import { Router, type Request, type Response } from 'express';

export const router = Router();

router.get('/', (_req: Request, res: Response) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    version: process.env.npm_package_version || '0.0.1'
  });
});
```

**src/index.ts:**
```typescript
import express, { type Express, type Request, type Response, type NextFunction } from 'express';
import cors from 'cors';
import dotenv from 'dotenv';
import { router as healthRouter } from './routes/health.js';
import { checkClaudeAvailable } from './services/agentService.js';

dotenv.config();

const app: Express = express();
const PORT = process.env.PORT || 3002;

app.use(cors());
app.use(express.json());

// Routes
app.use('/api/health', healthRouter);

// Error handling middleware (Express 5 supports async errors natively)
app.use((err: Error, _req: Request, res: Response, _next: NextFunction) => {
  console.error('Server error:', err);
  res.status(500).json({ error: 'Internal server error' });
});

// Startup
const claudeAvailable = checkClaudeAvailable();

app.listen(PORT, () => {
  console.log(`Server running on port ${PORT}`);
  console.log(`Health check: http://localhost:${PORT}/api/health`);
  console.log(`Claude CLI available: ${claudeAvailable}`);
  if (!claudeAvailable) {
    console.warn('Warning: Claude CLI not found. Install with: npm install -g @anthropic-ai/claude-code');
  }
});
```

### Task 3: Create Agent SDK service with availability check

**Files**:
- `apps/claude-code-web/server/src/services/agentService.ts`
- `apps/claude-code-web/server/src/types/index.ts`

**Action**: Create

**src/types/index.ts:**
```typescript
export interface AgentQueryOptions {
  prompt: string;
  sessionId?: string;
  cwd?: string;
}

export interface HealthResponse {
  status: 'ok' | 'error';
  timestamp: string;
  version: string;
  claudeAvailable?: boolean;
}
```

**src/services/agentService.ts:**
```typescript
import { execSync } from 'child_process';
import type { AgentQueryOptions } from '../types/index.js';

/**
 * Check if Claude CLI is available on the system.
 * Returns true if claude command is found, false otherwise.
 */
export function checkClaudeAvailable(): boolean {
  try {
    execSync('which claude', { encoding: 'utf8', stdio: 'pipe' });
    return true;
  } catch {
    return false;
  }
}

/**
 * Placeholder for Agent SDK query function.
 * Will be implemented in Plan 01-03 when SSE streaming is added.
 */
export async function* queryAgent(
  _options: AgentQueryOptions
): AsyncGenerator<unknown> {
  // Placeholder - actual implementation in Plan 01-03
  yield { type: 'placeholder', message: 'Agent SDK streaming not yet implemented' };
}
```

## Verification

- [ ] `cd apps/claude-code-web/server && pnpm install` completes without errors
- [ ] `cd apps/claude-code-web/server && pnpm typecheck` passes with no errors
- [ ] `cd apps/claude-code-web/server && pnpm dev` starts server on port 3002
- [ ] `curl http://localhost:3002/api/health` returns `{"status":"ok",...}`
- [ ] Server logs whether Claude CLI is available at startup

## Dependencies

- None (first plan in phase)
