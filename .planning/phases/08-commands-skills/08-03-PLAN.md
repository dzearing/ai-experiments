---
phase: 08-commands-skills
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/claude-code-web/server/src/services/commandsService.ts
  - apps/claude-code-web/server/src/routes/commands.ts
autonomous: true

must_haves:
  truths:
    - "Commands support $1, $2, $ARGUMENTS argument substitution"
    - "Commands with !`bash` syntax execute bash and inject output"
    - "Processed command content is returned via API for execution"
  artifacts:
    - path: "apps/claude-code-web/server/src/services/commandsService.ts"
      provides: "Argument substitution and bash pre-execution"
      exports: ["CommandsService", "commandsService"]
    - path: "apps/claude-code-web/server/src/routes/commands.ts"
      provides: "POST /api/commands/execute endpoint"
      contains: "router.post"
  key_links:
    - from: "apps/claude-code-web/server/src/routes/commands.ts"
      to: "commandsService.processCommand"
      via: "execute endpoint"
      pattern: "commandsService\\.processCommand"
---

<objective>
Add argument substitution ($1, $2, $ARGUMENTS) and bash pre-execution (!`command`) support to CommandsService, enabling custom commands to receive arguments and inject dynamic context.

Purpose: Match Claude Code CLI command execution semantics where commands can be parameterized and can inject bash output into the prompt.

Output: processCommand method that handles argument substitution and bash execution, with API endpoint to invoke it.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-commands-skills/08-RESEARCH.md
@.planning/phases/08-commands-skills/08-01-SUMMARY.md
@apps/claude-code-web/server/src/services/commandsService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add argument substitution to CommandsService</name>
  <files>apps/claude-code-web/server/src/services/commandsService.ts</files>
  <action>
Add argument substitution method to CommandsService.

Add new method `substituteArguments(content: string, args: string): string`:
1. Split args by whitespace into argParts array
2. Replace $1, $2, etc. with corresponding argParts (use regex: /\$(\d+)/g)
3. Replace $ARGUMENTS with full args string
4. If $ARGUMENTS wasn't in original content and args is non-empty, append "\n\nARGUMENTS: {args}"
5. Return processed content

Handle edge cases:
- Empty args: don't add ARGUMENTS section, leave $N as-is (or remove them)
- Missing positional arg: replace with empty string

Example:
```
Content: "Fix issue #$1 in $ARGUMENTS"
Args: "123 frontend"
Result: "Fix issue #123 in 123 frontend"
```
  </action>
  <verify>TypeScript compiles: `cd apps/claude-code-web/server && pnpm build`</verify>
  <done>substituteArguments method handles $1, $2, $ARGUMENTS substitution</done>
</task>

<task type="auto">
  <name>Task 2: Add bash pre-execution to CommandsService</name>
  <files>apps/claude-code-web/server/src/services/commandsService.ts</files>
  <action>
Add bash pre-execution method to CommandsService.

Import child_process exec (promisified via util.promisify) or use execSync wrapped.

Add new method `async preprocessBashCommands(content: string, cwd: string): Promise<string>`:
1. Match all !`command` patterns in content using regex: /!`([^`]+)`/g
2. For each match:
   a. Execute the command using exec with { cwd } option
   b. Capture stdout
   c. Replace the !`command` in content with stdout.trim()
   d. On error, replace with `[Error running {command}: {error.message}]`
3. Return processed content

Security note: Commands only execute if the command definition has allowed-tools that include Bash. This method assumes caller has validated this.

Example:
```
Content: "Current branch: !`git branch --show-current`"
Result: "Current branch: main"
```
  </action>
  <verify>TypeScript compiles: `cd apps/claude-code-web/server && pnpm build`</verify>
  <done>preprocessBashCommands method executes bash and injects output</done>
</task>

<task type="auto">
  <name>Task 3: Add processCommand method and execute endpoint</name>
  <files>apps/claude-code-web/server/src/services/commandsService.ts, apps/claude-code-web/server/src/routes/commands.ts</files>
  <action>
Add processCommand to CommandsService:

```typescript
async processCommand(
  commandName: string,
  args: string,
  projectRoot: string
): Promise<{ content: string; allowedTools?: string[]; model?: string } | null>
```

Implementation:
1. Load commands via loadCommands(projectRoot)
2. Find command by name (case-insensitive match)
3. If not found, return null
4. Apply substituteArguments to content
5. If command has allowedTools including 'Bash*' or 'Bash(*)' pattern, apply preprocessBashCommands
6. Return { content: processedContent, allowedTools: command.allowedTools, model: command.model }

Update routes/commands.ts to add POST /execute endpoint:

```typescript
router.post('/execute', async (req, res) => {
  const { command, args, cwd } = req.body;

  if (!command || !cwd) {
    return res.status(400).json({ error: 'Missing command or cwd' });
  }

  try {
    const projectRoot = await configService.findProjectRoot(cwd);
    const result = await commandsService.processCommand(command, args || '', projectRoot);

    if (!result) {
      return res.status(404).json({ error: `Unknown command: ${command}` });
    }

    res.json(result);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});
```
  </action>
  <verify>
TypeScript compiles: `cd apps/claude-code-web/server && pnpm build`
Manual test: Create command with !`git status`, call execute endpoint, verify output
  </verify>
  <done>POST /api/commands/execute processes command with argument substitution and bash execution</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. substituteArguments replaces $1, $2, $ARGUMENTS correctly
3. preprocessBashCommands executes bash and injects output
4. POST /api/commands/execute returns processed command content
5. Commands without Bash in allowed-tools skip bash preprocessing
</verification>

<success_criteria>
- $1, $2, $ARGUMENTS are substituted with provided arguments
- !`bash command` executes and output is injected
- /api/commands/execute endpoint works for custom commands
- Unknown commands return 404
- Bash errors are gracefully handled and shown in output
</success_criteria>

<output>
After completion, create `.planning/phases/08-commands-skills/08-03-SUMMARY.md`
</output>
