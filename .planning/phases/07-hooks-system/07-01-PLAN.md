---
phase: 07-hooks-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/claude-code-web/server/src/types/hooks.ts
  - apps/claude-code-web/server/src/types/config.ts
  - apps/claude-code-web/server/src/services/hooksService.ts
autonomous: true

must_haves:
  truths:
    - "Hook type definitions exist for all 11 SDK hook events"
    - "HooksService can build SDK-compatible hook callbacks from configuration"
    - "Settings type includes hooks configuration schema"
  artifacts:
    - path: "apps/claude-code-web/server/src/types/hooks.ts"
      provides: "Hook event types, input types, output types, config schema"
      exports: ["HookEvent", "HookConfig", "HookCallback", "HookJSONOutput"]
    - path: "apps/claude-code-web/server/src/services/hooksService.ts"
      provides: "HooksService class with createHookCallbacks factory"
      exports: ["HooksService", "hooksService"]
  key_links:
    - from: "hooksService.ts"
      to: "types/hooks.ts"
      via: "import types"
      pattern: "import.*from.*types/hooks"
    - from: "types/config.ts"
      to: "types/hooks.ts"
      via: "HooksConfig type reference"
      pattern: "hooks\\?:.*HooksConfig"
---

<objective>
Create the hook type definitions and HooksService foundation for the hooks system.

Purpose: Establish the type-safe foundation that all hook implementations will use. The SDK provides TypeScript callback-based hooks - we need types that match the SDK API and a service that can build these callbacks from configuration.

Output: Hook types file, extended config types, and HooksService skeleton that plans 07-02 and 07-03 will implement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hooks-system/07-RESEARCH.md

# Existing code to extend
@apps/claude-code-web/server/src/types/config.ts
@apps/claude-code-web/server/src/types/index.ts
@apps/claude-code-web/server/src/services/agentService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hook type definitions</name>
  <files>apps/claude-code-web/server/src/types/hooks.ts</files>
  <action>
Create comprehensive hook type definitions matching the SDK API documented in 07-RESEARCH.md.

Define:
1. HookEvent union type for all 11 events: 'PreToolUse' | 'PostToolUse' | 'PostToolUseFailure' | 'UserPromptSubmit' | 'SessionStart' | 'SessionEnd' | 'Stop' | 'SubagentStart' | 'SubagentStop' | 'PreCompact' | 'PermissionRequest' | 'Notification'

2. BaseHookInput interface with common fields:
   - hook_event_name: string
   - session_id: string
   - transcript_path: string
   - cwd: string
   - permission_mode?: string

3. Specific input interfaces extending BaseHookInput:
   - PreToolUseHookInput: tool_name, tool_input
   - PostToolUseHookInput: tool_name, tool_input, tool_response
   - SessionStartHookInput: source ('startup' | 'resume' | 'clear' | 'compact')
   - SessionEndHookInput: reason ('clear' | 'logout' | 'prompt_input_exit' | 'bypass_permissions_disabled' | 'other')
   - SubagentStartHookInput: agent_id, agent_type
   - SubagentStopHookInput: stop_hook_active, agent_id, agent_transcript_path
   - UserPromptSubmitHookInput: prompt
   - PreCompactHookInput: trigger ('manual' | 'auto'), custom_instructions?
   - PermissionRequestHookInput: tool_name, tool_input, permission_suggestions?

4. HookJSONOutput interface:
   - continue?: boolean
   - stopReason?: string
   - suppressOutput?: boolean
   - systemMessage?: string
   - hookSpecificOutput?: { hookEventName, permissionDecision?, permissionDecisionReason?, updatedInput?, additionalContext? }

5. HookCallback type: (input: HookInput, toolUseID: string | undefined, options: { signal: AbortSignal }) => Promise<HookJSONOutput>

6. HooksConfig interface for settings.json schema:
   - Map of HookEvent to array of { matcher?: string, action: string, options?: Record<string, unknown> }

7. HookMatcher interface: { matcher?: string, hooks: HookCallback[] }

8. SDKHooksOptions type: Partial<Record<HookEvent, HookMatcher[]>>

Export all types.
  </action>
  <verify>Run `npx tsc --noEmit -p apps/claude-code-web/server/tsconfig.json` - no errors related to hooks.ts</verify>
  <done>All 11 hook event types defined with proper input/output interfaces matching SDK API</done>
</task>

<task type="auto">
  <name>Task 2: Extend config types and create HooksService</name>
  <files>apps/claude-code-web/server/src/types/config.ts, apps/claude-code-web/server/src/services/hooksService.ts</files>
  <action>
1. Update types/config.ts:
   - Import HooksConfig from './hooks.js'
   - Add `hooks?: HooksConfig` to Settings interface

2. Create services/hooksService.ts with HooksService class:

```typescript
import { minimatch } from 'minimatch';
import type { HooksConfig, SDKHooksOptions, HookEvent, HookCallback, HookMatcher } from '../types/hooks.js';

export class HooksService {
  /**
   * Build SDK-compatible hook callbacks from configuration.
   * Transforms settings.json hook definitions into TypeScript callbacks.
   */
  createHookCallbacks(config: HooksConfig): SDKHooksOptions {
    const hooks: SDKHooksOptions = {};

    for (const [event, matchers] of Object.entries(config)) {
      const hookEvent = event as HookEvent;
      hooks[hookEvent] = matchers.map(m => ({
        matcher: m.matcher,
        hooks: [this.createCallbackForAction(m.action, m.options)]
      }));
    }

    return hooks;
  }

  /**
   * Create a hook callback for a built-in action type.
   * Supported actions: 'log', 'notify', 'block-pattern', 'allow', 'deny'
   */
  private createCallbackForAction(action: string, options?: Record<string, unknown>): HookCallback {
    switch (action) {
      case 'log':
        return this.createLogHook();
      case 'notify':
        return this.createNotifyHook(options);
      case 'block-pattern':
        return this.createBlockPatternHook(options);
      case 'allow':
        return this.createAllowHook();
      case 'deny':
        return this.createDenyHook(options);
      default:
        console.warn(`[HooksService] Unknown hook action: ${action}`);
        return this.createNoOpHook();
    }
  }

  // Placeholder implementations - will be completed in subsequent plans
  private createLogHook(): HookCallback {
    return async (input) => {
      console.log(`[Hook] ${input.hook_event_name}`, input);
      return {};
    };
  }

  private createNotifyHook(options?: Record<string, unknown>): HookCallback {
    return async () => ({});
  }

  private createBlockPatternHook(options?: Record<string, unknown>): HookCallback {
    return async () => ({});
  }

  private createAllowHook(): HookCallback {
    return async (input) => ({
      hookSpecificOutput: {
        hookEventName: input.hook_event_name,
        permissionDecision: 'allow' as const
      }
    });
  }

  private createDenyHook(options?: Record<string, unknown>): HookCallback {
    const reason = (options?.reason as string) || 'Denied by hook';
    return async (input) => ({
      hookSpecificOutput: {
        hookEventName: input.hook_event_name,
        permissionDecision: 'deny' as const,
        permissionDecisionReason: reason
      }
    });
  }

  private createNoOpHook(): HookCallback {
    return async () => ({});
  }

  /**
   * Check if a tool name matches a pattern.
   * Supports glob patterns via minimatch.
   */
  matchesTool(toolName: string, pattern: string): boolean {
    return minimatch(toolName, pattern);
  }
}

export const hooksService = new HooksService();
```

The HooksService provides:
- Factory method to build SDK hooks from config
- Pattern matching via minimatch (already a dependency)
- Placeholder hook implementations for each action type
  </action>
  <verify>Run `npx tsc --noEmit -p apps/claude-code-web/server/tsconfig.json` - no errors. Check that HooksService is properly typed.</verify>
  <done>Settings includes hooks config, HooksService exists with createHookCallbacks factory method</done>
</task>

<task type="auto">
  <name>Task 3: Wire HooksService into AgentService</name>
  <files>apps/claude-code-web/server/src/services/agentService.ts</files>
  <action>
Update agentService.ts to use HooksService when hooks are configured:

1. Import hooksService:
   ```typescript
   import { hooksService } from './hooksService.js';
   ```

2. In streamAgentQuery, after loading config, check for hooks and build callbacks:
   ```typescript
   // Build hooks from configuration if present
   let sdkHooks = undefined;
   if (config.settings.hooks) {
     sdkHooks = hooksService.createHookCallbacks(config.settings.hooks);
   }
   ```

3. Add hooks to queryOptions if present:
   ```typescript
   if (sdkHooks) {
     queryOptions.hooks = sdkHooks;
   }
   ```

This integrates hooks with the existing SDK query flow. When settings.json contains a `hooks` section, those hooks will be passed to the SDK.

Note: Do NOT remove or modify the existing canUseTool callback - hooks work alongside permissions, not instead of them. The SDK handles both.
  </action>
  <verify>Run `npx tsc --noEmit -p apps/claude-code-web/server/tsconfig.json` - no errors. Verify agentService imports hooksService.</verify>
  <done>AgentService passes hooks from settings to SDK query when configured</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit -p apps/claude-code-web/server/tsconfig.json`
2. All 11 hook event types defined in hooks.ts
3. Settings interface includes hooks?: HooksConfig
4. HooksService.createHookCallbacks returns SDK-compatible hook structure
5. AgentService uses hooksService when hooks are configured
</verification>

<success_criteria>
- Hook type definitions cover all SDK hook events (11 types)
- HooksService can transform config into SDK callbacks
- AgentService integrates hooks into query flow
- TypeScript compiles cleanly
- Foundation ready for tool hooks (07-02) and lifecycle hooks (07-03)
</success_criteria>

<output>
After completion, create `.planning/phases/07-hooks-system/07-01-SUMMARY.md`
</output>
