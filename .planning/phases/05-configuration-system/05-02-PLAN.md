---
phase: 05-configuration-system
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/claude-code-web/server/src/services/configService.ts
  - apps/claude-code-web/server/src/services/agentService.ts
  - apps/claude-code-web/server/src/routes/agent.ts
  - apps/claude-code-web/server/src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Rules load from .claude/rules/**/*.md recursively"
    - "Rules with paths frontmatter filter by file glob"
    - "Unconditional rules always apply"
    - "Working directory can be specified in stream request"
    - "Environment variables pass through to SDK"
    - "System prompt includes CLAUDE.md content and rules"
  artifacts:
    - path: "apps/claude-code-web/server/src/services/configService.ts"
      provides: "loadModularRules and getApplicableRules methods"
      contains: "loadModularRules"
    - path: "apps/claude-code-web/server/src/services/agentService.ts"
      provides: "Config integration with SDK query"
      contains: "configService.loadConfig"
    - path: "apps/claude-code-web/server/src/routes/agent.ts"
      provides: "cwd and env parameters in stream endpoint"
      contains: "cwd.*req.query"
  key_links:
    - from: "agentService.ts"
      to: "configService.ts"
      via: "config loading"
      pattern: "configService\\.loadConfig"
    - from: "configService.loadModularRules"
      to: "gray-matter"
      via: "frontmatter parsing"
      pattern: "matter\\("
    - from: "agentService.streamAgentQuery"
      to: "SDK query"
      via: "systemPrompt.append"
      pattern: "systemPrompt.*append"
---

<objective>
Complete the configuration system by adding modular rules loading and integrating ConfigService with the agent streaming infrastructure.

Purpose: Enable teams to organize project rules in .claude/rules/ directory and ensure all configuration flows through to the SDK for use in Claude's system prompt.

Output: Full configuration pipeline from file system to SDK query, with rules loading and environment passthrough.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-system/05-RESEARCH.md
@.planning/phases/05-configuration-system/05-01-SUMMARY.md

# Files to modify
@apps/claude-code-web/server/src/services/configService.ts
@apps/claude-code-web/server/src/services/agentService.ts
@apps/claude-code-web/server/src/routes/agent.ts
@apps/claude-code-web/server/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add modular rules loading to ConfigService</name>
  <files>
    apps/claude-code-web/server/src/services/configService.ts
  </files>
  <action>
Add rules loading to ConfigService:

1. Import dependencies at top of file:
```typescript
import matter from 'gray-matter';
import { glob } from 'glob';
import { minimatch } from 'minimatch';
```

Note: minimatch is already installed (used in Phase 4).

2. `loadModularRules(projectRoot: string): Promise<RuleFile[]>` - Load all rules from .claude/rules/:
   - Check if `{projectRoot}/.claude/rules` exists
   - If not, return empty array
   - Use glob to find all `**/*.md` files recursively
   - For each file, use gray-matter to parse frontmatter
   - Extract `paths` field from frontmatter (optional glob pattern)
   - Return array of RuleFile objects

3. `getApplicableRules(rules: RuleFile[], filePath?: string): string[]` - Filter rules for a specific file:
   - If no filePath, return all rules (unconditional rules apply everywhere)
   - For each rule:
     - If no paths field, rule always applies
     - If paths field exists, use minimatch to check if filePath matches any pattern
   - Return content strings of matching rules

4. `buildSystemPrompt(claudeMd: string, rules: RuleFile[]): string` - Combine CLAUDE.md and rules:
   - Start with CLAUDE.md content
   - Filter to unconditional rules (no paths field)
   - If any unconditional rules, append "## Project Rules" section
   - Join with double newlines

5. Update `loadConfig()` to:
   - Call loadModularRules
   - Call buildSystemPrompt with CLAUDE.md and rules
   - Populate rules array in SessionConfig
  </action>
  <verify>
Run `pnpm typecheck` in server directory.
Create a test .claude/rules/test-rule.md file manually to verify loading.
  </verify>
  <done>
Rules load from .claude/rules/**/*.md with frontmatter parsing. getApplicableRules filters by path. buildSystemPrompt merges CLAUDE.md and rules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ConfigService with agentService</name>
  <files>
    apps/claude-code-web/server/src/services/agentService.ts
    apps/claude-code-web/server/src/types/index.ts
  </files>
  <action>
Update agentService to use ConfigService:

1. Add to types/index.ts - extend StreamAgentOptions:
```typescript
// Already exists, add env field
export interface AgentQueryOptions {
  prompt: string;
  sessionId?: string;
  cwd?: string;
  env?: Record<string, string>;  // ADD this
}
```

2. In agentService.ts:

Import configService:
```typescript
import { configService } from './configService.js';
```

Update StreamAgentOptions interface to include env:
```typescript
export interface StreamAgentOptions {
  prompt: string;
  sessionId?: string;
  cwd?: string;
  permissionMode?: PermissionMode;
  env?: Record<string, string>;  // ADD this
}
```

Update streamAgentQuery function:
- Get cwd from options or default to process.cwd()
- Get env from options or default to empty object
- Call `configService.loadConfig(cwd, env)` to get SessionConfig
- Use config.systemPrompt in SDK query options via systemPrompt.append
- Use config.env in SDK query options via env parameter
- Use config.cwd in SDK query options

SDK query options should look like:
```typescript
const queryOptions = {
  resume: sessionId || undefined,
  cwd: config.cwd,
  env: config.env,
  includePartialMessages: true,
  permissionMode: permissionMode === 'bypassPermissions' ? 'bypassPermissions' : undefined,
  systemPrompt: config.systemPrompt
    ? {
        type: 'preset' as const,
        preset: 'claude_code' as const,
        append: config.systemPrompt,
      }
    : { type: 'preset' as const, preset: 'claude_code' as const },
};
```

Handle the canUseTool callback integration (keep existing logic, just add config loading before).
  </action>
  <verify>
Run `pnpm typecheck` in server directory.
Run `pnpm dev` and send a test message to verify streaming still works.
  </verify>
  <done>
agentService loads configuration at query start. System prompt includes CLAUDE.md and rules. Environment variables pass through to SDK.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cwd and env parameters to stream endpoint</name>
  <files>
    apps/claude-code-web/server/src/routes/agent.ts
  </files>
  <action>
Update the /stream endpoint to accept cwd and env parameters:

1. Update query parameter extraction:
```typescript
const { prompt, sessionId, permissionMode: modeParam, cwd } = req.query as {
  prompt?: string;
  sessionId?: string;
  permissionMode?: string;
  cwd?: string;
};
```

Note: env should come from request body for security (not query string), but for GET endpoint simplicity, we'll support it as a JSON-encoded query param for now.

2. Parse cwd - validate it's an absolute path:
```typescript
// Validate cwd if provided
let workingDirectory = cwd;
if (cwd) {
  // Basic validation - must be absolute path
  if (!path.isAbsolute(cwd)) {
    res.status(400).json({
      error: 'cwd must be an absolute path',
      code: 'INVALID_CWD',
    });
    return;
  }
}
```

Import path at top: `import path from 'path';`

3. Pass cwd to streamAgentQuery:
```typescript
for await (const message of streamAgentQuery({
  prompt,
  sessionId: effectiveSessionId,
  permissionMode,
  cwd: workingDirectory,  // ADD this
})) {
  // ... existing streaming logic
}
```

4. Add a GET /api/agent/config endpoint for debugging:
```typescript
router.get('/config', async (req: Request, res: Response) => {
  const { cwd } = req.query as { cwd?: string };

  if (!cwd) {
    res.status(400).json({
      error: 'Missing required parameter: cwd',
      code: 'MISSING_CWD',
    });
    return;
  }

  try {
    const config = await configService.loadConfig(cwd);

    res.json({
      projectRoot: config.projectRoot,
      cwd: config.cwd,
      hasSystemPrompt: config.systemPrompt.length > 0,
      systemPromptLength: config.systemPrompt.length,
      settingsKeys: Object.keys(config.settings),
      rulesCount: config.rules.length,
      envKeys: Object.keys(config.env),
    });
  } catch (error) {
    res.status(500).json({
      error: error instanceof Error ? error.message : String(error),
      code: 'CONFIG_LOAD_ERROR',
    });
  }
});
```

Import configService at top: `import { configService } from '../services/configService.js';`
  </action>
  <verify>
Run `pnpm typecheck` in server directory.
Run `pnpm dev` and test:
- `curl "http://localhost:3002/api/agent/config?cwd=/Users/your-user/some-project"`
- Verify config endpoint returns expected structure
  </verify>
  <done>
Stream endpoint accepts cwd parameter. Config debug endpoint exists at /api/agent/config. Working directory flows through to SDK.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd apps/claude-code-web/server && pnpm typecheck` passes
2. `pnpm dev` starts server without errors
3. GET /api/agent/config?cwd=... returns config info
4. Streaming endpoint accepts cwd parameter
5. Rules load from .claude/rules/ if present
</verification>

<success_criteria>
- [ ] loadModularRules discovers .claude/rules/**/*.md files
- [ ] gray-matter parses frontmatter from rule files
- [ ] getApplicableRules filters by paths glob pattern
- [ ] buildSystemPrompt combines CLAUDE.md and unconditional rules
- [ ] agentService calls configService.loadConfig before SDK query
- [ ] SDK query includes systemPrompt.append with config content
- [ ] SDK query includes env from merged environment
- [ ] Stream endpoint accepts cwd query parameter
- [ ] Config debug endpoint returns project configuration info
- [ ] Server typechecks and runs without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-system/05-02-SUMMARY.md`
</output>
