---
phase: 05-configuration-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/claude-code-web/server/package.json
  - apps/claude-code-web/server/src/types/config.ts
  - apps/claude-code-web/server/src/services/configService.ts
autonomous: true

must_haves:
  truths:
    - "CLAUDE.md loads from ~/.claude/CLAUDE.md (global)"
    - "CLAUDE.md loads from project root CLAUDE.md"
    - "CLAUDE.md loads from CLAUDE.local.md (gitignored)"
    - "Settings load from ~/.claude/settings.json (user)"
    - "Settings load from .claude/settings.json (project)"
    - "Settings load from .claude/settings.local.json (local)"
    - "Higher priority sources override lower priority sources"
  artifacts:
    - path: "apps/claude-code-web/server/src/types/config.ts"
      provides: "Configuration type definitions"
      exports: ["SessionConfig", "Settings", "RuleFile"]
    - path: "apps/claude-code-web/server/src/services/configService.ts"
      provides: "ConfigService class with loadConfig method"
      exports: ["ConfigService", "configService"]
  key_links:
    - from: "configService.ts"
      to: "types/config.ts"
      via: "type imports"
      pattern: "import.*from.*config"
    - from: "configService.loadClaudeMdHierarchy"
      to: "fs/promises"
      via: "file reading"
      pattern: "fs\\.readFile"
---

<objective>
Create the core ConfigService that loads CLAUDE.md and settings.json from their respective hierarchies.

Purpose: Enable project-specific instructions and settings to be loaded at session start, providing Claude with context about coding conventions, project rules, and user preferences.

Output: ConfigService class with methods to load and merge configuration from global, project, and local sources.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-configuration-system/05-RESEARCH.md

# Existing server structure
@apps/claude-code-web/server/src/services/agentService.ts
@apps/claude-code-web/server/src/types/index.ts
@apps/claude-code-web/server/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create configuration types</name>
  <files>
    apps/claude-code-web/server/package.json
    apps/claude-code-web/server/src/types/config.ts
  </files>
  <action>
Install dependencies in the server package:
```bash
cd apps/claude-code-web/server && pnpm add gray-matter glob
```

Create `src/types/config.ts` with these type definitions:

```typescript
// SessionConfig: Full configuration for a session
export interface SessionConfig {
  cwd: string;
  projectRoot: string;
  systemPrompt: string;
  settings: Settings;
  rules: RuleFile[];
  env: Record<string, string>;
}

// Settings: Parsed from settings.json hierarchy
export interface Settings {
  permissions?: PermissionRule[];
  env?: Record<string, string>;
  model?: string;
  // Add more fields as SDK supports them
}

// PermissionRule: For PERM-05 wildcard support
export interface PermissionRule {
  tool: string;  // Tool name or glob pattern (e.g., "Bash", "mcp__*")
  allow?: boolean;
  deny?: boolean;
}

// RuleFile: A single rule from .claude/rules/
export interface RuleFile {
  path: string;
  content: string;
  paths?: string;  // Glob pattern for path-specific rules
}

// ClaudeMdSource: Track where CLAUDE.md content came from
export interface ClaudeMdSource {
  path: string;
  content: string;
  level: 'global' | 'project' | 'local' | 'subdirectory';
}
```
  </action>
  <verify>
Run `cd apps/claude-code-web/server && pnpm typecheck` to verify types compile.
Check that gray-matter and glob are in package.json dependencies.
  </verify>
  <done>
Type definitions exist in config.ts, gray-matter and glob are installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConfigService with CLAUDE.md hierarchy loading</name>
  <files>
    apps/claude-code-web/server/src/services/configService.ts
  </files>
  <action>
Create `src/services/configService.ts` with ConfigService class.

Key methods to implement:

1. `findProjectRoot(startDir: string): Promise<string>` - Walk up from startDir looking for .git, package.json, or CLAUDE.md to identify project root. Return startDir if nothing found.

2. `loadClaudeMdHierarchy(cwd: string, projectRoot: string): Promise<string>` - Load and concatenate CLAUDE.md from:
   - Global: `~/.claude/CLAUDE.md`
   - Project: `{projectRoot}/CLAUDE.md`
   - Local: `{projectRoot}/CLAUDE.local.md`
   - Subdirectory: Any CLAUDE.md files between cwd and projectRoot

Use os.homedir() for ~ expansion. Join with double newlines. Handle missing files gracefully (they're optional).

3. `fileExists(path: string): Promise<boolean>` - Helper using fs.access().

4. Stub `loadConfig(cwd: string, sessionEnv?: Record<string, string>): Promise<SessionConfig>` that:
   - Calls findProjectRoot
   - Calls loadClaudeMdHierarchy
   - Returns SessionConfig with systemPrompt set to CLAUDE.md content
   - Stub out settings (empty object), rules (empty array), env (basic defaults)

Export singleton: `export const configService = new ConfigService();`

Use fs/promises, path, and os modules (all built-in, no imports needed from dependencies yet).
  </action>
  <verify>
Run `pnpm typecheck` in server directory to verify no type errors.
Manually test by adding temporary logging and running `pnpm dev`.
  </verify>
  <done>
ConfigService class exists with findProjectRoot, loadClaudeMdHierarchy, and stubbed loadConfig methods.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add settings.json hierarchy loading to ConfigService</name>
  <files>
    apps/claude-code-web/server/src/services/configService.ts
  </files>
  <action>
Add settings loading to ConfigService:

1. `loadSettingsHierarchy(projectRoot: string): Promise<Settings>` - Load and deep-merge settings from:
   - User: `~/.claude/settings.json` (priority 1, lowest)
   - Project: `{projectRoot}/.claude/settings.json` (priority 2)
   - Local: `{projectRoot}/.claude/settings.local.json` (priority 3, highest)

Use JSON.parse with try/catch for each file. Warn on parse errors but don't throw.

2. `deepMerge<T>(target: T, source: Partial<T>): T` - Recursive object merge. Arrays replace (not concat). Later sources override earlier.

3. Update `loadConfig()` to:
   - Call loadSettingsHierarchy
   - Populate settings field in SessionConfig
   - Merge settings.env with sessionEnv for env field

Priority for env: `settings.env < sessionEnv < PWD override`

Add basic env defaults:
```typescript
{
  HOME: process.env.HOME || '',
  PATH: process.env.PATH || '',
  SHELL: process.env.SHELL || '/bin/bash',
  TERM: 'xterm-256color',
  PWD: cwd,
}
```
  </action>
  <verify>
Run `pnpm typecheck` in server directory.
Run `pnpm dev` and verify server starts without errors.
  </verify>
  <done>
Settings load from hierarchy with correct precedence. Environment variables merge correctly. loadConfig returns complete SessionConfig (except rules, which is Plan 02).
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `cd apps/claude-code-web/server && pnpm typecheck` passes with no errors
2. `pnpm dev` starts server without errors
3. ConfigService exports configService singleton
4. Types are defined in config.ts
</verification>

<success_criteria>
- [ ] gray-matter and glob dependencies installed
- [ ] SessionConfig, Settings, RuleFile, PermissionRule types defined
- [ ] ConfigService.findProjectRoot works
- [ ] ConfigService.loadClaudeMdHierarchy loads from global/project/local/subdirectory
- [ ] ConfigService.loadSettingsHierarchy loads and merges with correct precedence
- [ ] ConfigService.loadConfig returns complete SessionConfig
- [ ] Server typechecks and starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-configuration-system/05-01-SUMMARY.md`
</output>
