---
phase: 04-permissions-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/claude-code-web/server/src/types/index.ts
  - apps/claude-code-web/server/src/services/agentService.ts
  - apps/claude-code-web/server/src/services/permissionService.ts
  - apps/claude-code-web/server/src/routes/agent.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SDK canUseTool callback sends permission_request SSE events to client"
    - "Permission response endpoint resolves pending permission promises"
    - "AskUserQuestion tool sends question_request SSE event (not permission_request)"
    - "Permission requests timeout at 55s with deny response"
    - "Session tracks current permission mode"
  artifacts:
    - path: "apps/claude-code-web/server/src/types/index.ts"
      provides: "Permission types (PermissionMode, PermissionRequest, PermissionResponse)"
      contains: "PermissionMode"
    - path: "apps/claude-code-web/server/src/services/permissionService.ts"
      provides: "Pending permission management"
      exports: ["createPermissionRequest", "resolvePermission", "PendingPermission"]
    - path: "apps/claude-code-web/server/src/services/agentService.ts"
      provides: "canUseTool callback implementation"
      contains: "canUseTool"
    - path: "apps/claude-code-web/server/src/routes/agent.ts"
      provides: "Permission response endpoint"
      contains: "permission-response"
  key_links:
    - from: "apps/claude-code-web/server/src/services/agentService.ts"
      to: "permissionService"
      via: "import and call createPermissionRequest"
      pattern: "createPermissionRequest"
    - from: "apps/claude-code-web/server/src/routes/agent.ts"
      to: "permissionService"
      via: "import and call resolvePermission"
      pattern: "resolvePermission"
---

<objective>
Implement server-side permission infrastructure with canUseTool callback that surfaces permission requests to the client via SSE events.

Purpose: Replace hardcoded bypassPermissions mode with proper permission handling that allows users to approve/deny tool usage.
Output: Server endpoints and services for permission request/response flow, SSE events for permission_request and question_request.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-permissions-modes/04-RESEARCH.md

# Existing server infrastructure
@apps/claude-code-web/server/src/types/index.ts
@apps/claude-code-web/server/src/services/agentService.ts
@apps/claude-code-web/server/src/routes/agent.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add permission types</name>
  <files>apps/claude-code-web/server/src/types/index.ts</files>
  <action>
Add permission-related types to the existing types file:

1. `PermissionMode` type: 'default' | 'plan' | 'acceptEdits' | 'bypassPermissions'

2. `PermissionRequest` interface with fields:
   - requestId: string
   - toolName: string
   - input: Record<string, unknown>
   - timestamp: number

3. `PermissionResponse` interface with fields:
   - requestId: string
   - behavior: 'allow' | 'deny'
   - message?: string
   - updatedInput?: Record<string, unknown>

4. `QuestionRequest` interface with fields:
   - requestId: string
   - questions: Array of { question: string; options: Array<{ label: string; description?: string }>; multiSelect?: boolean }
   - timestamp: number

5. `QuestionResponse` interface with fields:
   - requestId: string
   - answers: Record<string, string>

6. SSE event types:
   - `PermissionRequestEvent`: type 'permission_request' + PermissionRequest fields
   - `QuestionRequestEvent`: type 'question_request' + QuestionRequest fields
   - `ModeChangedEvent`: type 'mode_changed' + mode: PermissionMode + timestamp

Add these to the existing SDKMessage union or create a separate SSEEvent union type.
  </action>
  <verify>TypeScript compiles without errors: `cd apps/claude-code-web/server && pnpm build`</verify>
  <done>Permission types exported from types/index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create permission service with pending request tracking</name>
  <files>apps/claude-code-web/server/src/services/permissionService.ts</files>
  <action>
Create a new service for managing pending permission requests:

1. `PendingPermission` interface:
   - resolve: (result: PermissionResult) => void
   - reject: (error: Error) => void
   - toolName: string
   - input: Record<string, unknown>
   - timestamp: number
   - timeoutId: NodeJS.Timeout

2. `pendingPermissions` Map<string, PendingPermission> for tracking active requests

3. `createPermissionRequest(toolName, input, signal)` function:
   - Generate UUID for requestId
   - Create Promise that stores resolve/reject in pendingPermissions map
   - Set 55s timeout (before SDK's 60s) that auto-denies with "Permission request timed out"
   - Clean up on abort signal
   - Return { requestId, promise }

4. `resolvePermission(requestId, response)` function:
   - Look up pending permission by requestId
   - If not found, return { error: 'Permission request not found or expired' }
   - Clear timeout
   - Delete from map
   - Call resolve with PermissionResult based on response.behavior
   - Return { success: true }

5. `getPendingCount()` function for monitoring

Export: createPermissionRequest, resolvePermission, getPendingCount, PendingPermission type
  </action>
  <verify>TypeScript compiles: `cd apps/claude-code-web/server && pnpm build`</verify>
  <done>permissionService.ts exports createPermissionRequest, resolvePermission, getPendingCount</done>
</task>

<task type="auto">
  <name>Task 3: Implement canUseTool callback and wire permission endpoints</name>
  <files>
    apps/claude-code-web/server/src/services/agentService.ts
    apps/claude-code-web/server/src/routes/agent.ts
  </files>
  <action>
**In agentService.ts:**

1. Add import for permissionService functions
2. Add `activeConnections` Map to track SSE connections by sessionId for sending events
3. Add `registerConnection(sessionId, res)` and `unregisterConnection(sessionId)` functions
4. Add `sendSSEEvent(sessionId, event)` function that writes to the registered Response

5. Modify `StreamAgentOptions` to include:
   - permissionMode: PermissionMode (default 'default')

6. Implement canUseTool callback function:
   ```typescript
   const canUseTool: CanUseTool = async (toolName, input, { signal }) => {
     // Special handling for AskUserQuestion - send as question_request
     if (toolName === 'AskUserQuestion') {
       const { requestId, promise } = createPermissionRequest(toolName, input, signal);
       sendSSEEvent(currentSessionId, {
         type: 'question_request',
         requestId,
         questions: (input as { questions: unknown[] }).questions,
         timestamp: Date.now(),
       });
       return promise;
     }

     // Regular permission request
     const { requestId, promise } = createPermissionRequest(toolName, input, signal);
     sendSSEEvent(currentSessionId, {
       type: 'permission_request',
       requestId,
       toolName,
       input,
       timestamp: Date.now(),
     });
     return promise;
   };
   ```

7. Update query() call to use canUseTool callback based on permissionMode:
   - If 'bypassPermissions': use permissionMode: 'bypassPermissions' (no callback)
   - Otherwise: pass canUseTool callback and set permissionMode accordingly

**In routes/agent.ts:**

1. Import resolvePermission from permissionService
2. Import registerConnection, unregisterConnection from agentService

3. In /stream endpoint:
   - Extract permissionMode from query params (default 'default')
   - Register connection with sessionId before streaming
   - Unregister on close

4. Add POST `/permission-response` endpoint:
   - Extract { requestId, behavior, message, updatedInput } from body
   - Call resolvePermission(requestId, { behavior, message, updatedInput })
   - Return result (success or error)

5. Add POST `/question-response` endpoint:
   - Extract { requestId, answers } from body
   - Call resolvePermission(requestId, { behavior: 'allow', updatedInput: { answers } })
   - Return result
  </action>
  <verify>
1. Build passes: `cd apps/claude-code-web/server && pnpm build`
2. Server starts: `cd apps/claude-code-web/server && timeout 5 pnpm dev || true`
  </verify>
  <done>
- canUseTool callback implemented in agentService
- Permission response POST endpoint at /api/agent/permission-response
- Question response POST endpoint at /api/agent/question-response
- SSE events sent for permission_request and question_request
  </done>
</task>

</tasks>

<verification>
1. Server builds without TypeScript errors
2. Server starts and responds to health check
3. Permission types are properly exported
4. New endpoints respond (POST to /api/agent/permission-response returns 404 for missing requestId)
</verification>

<success_criteria>
- Server compiles and runs
- PermissionMode, PermissionRequest, PermissionResponse types exported
- canUseTool callback sends SSE events to client
- Permission response endpoint resolves pending promises
- AskUserQuestion handled separately with question_request event type
</success_criteria>

<output>
After completion, create `.planning/phases/04-permissions-modes/04-01-SUMMARY.md`
</output>
