---
phase: 04-permissions-modes
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/claude-code-web/server/src/routes/agent.ts
  - apps/claude-code-web/client/src/components/ModeSelector.tsx
  - apps/claude-code-web/client/src/components/ModeSelector.module.css
  - apps/claude-code-web/client/src/components/ChatView.tsx
  - apps/claude-code-web/client/src/hooks/useAgentStream.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Mode indicator shows current execution mode"
    - "User can change mode mid-session"
    - "Plan mode restricts to read-only operations"
    - "Bypass permissions mode shows warning before activation"
    - "Mode selector is disabled while permission dialog is open"
  artifacts:
    - path: "apps/claude-code-web/client/src/components/ModeSelector.tsx"
      provides: "Mode selection UI"
      exports: ["ModeSelector"]
    - path: "apps/claude-code-web/server/src/routes/agent.ts"
      provides: "Mode change endpoint"
      contains: "/mode"
  key_links:
    - from: "apps/claude-code-web/client/src/components/ModeSelector.tsx"
      to: "/api/agent/mode"
      via: "fetch POST on mode change"
      pattern: "/api/agent/mode"
    - from: "apps/claude-code-web/client/src/components/ChatView.tsx"
      to: "ModeSelector"
      via: "import and render"
      pattern: "<ModeSelector"
---

<objective>
Implement mode selection UI and server endpoint for changing execution modes mid-session (default, plan, acceptEdits, bypassPermissions).

Purpose: Allow users to control how Claude interacts with tools - from full approval required to auto-approve all.
Output: ModeSelector component, mode change endpoint, mode state management in conversation flow.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-permissions-modes/04-RESEARCH.md
@.planning/phases/04-permissions-modes/04-01-SUMMARY.md

# Existing code
@apps/claude-code-web/server/src/routes/agent.ts
@apps/claude-code-web/client/src/hooks/useAgentStream.ts
@apps/claude-code-web/client/src/components/ChatView.tsx

# UI Kit Segmented component reference
@packages/ui-kit/react/src/components/Segmented/Segmented.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode change endpoint to server</name>
  <files>apps/claude-code-web/server/src/routes/agent.ts</files>
  <action>
Add a POST endpoint for changing the permission mode:

1. Add import for PermissionMode type from '../types/index.js'

2. Create a Map to track session modes:
   ```typescript
   const sessionModes = new Map<string, PermissionMode>();
   ```

3. Add helper function to get/set session mode:
   ```typescript
   export function getSessionMode(sessionId: string): PermissionMode {
     return sessionModes.get(sessionId) ?? 'default';
   }

   export function setSessionMode(sessionId: string, mode: PermissionMode): void {
     sessionModes.set(sessionId, mode);
   }
   ```

4. Add POST `/mode` endpoint:
   ```typescript
   router.post('/mode', (req: Request, res: Response) => {
     const { sessionId, mode } = req.body as { sessionId: string; mode: PermissionMode };

     if (!sessionId) {
       return res.status(400).json({ error: 'Missing sessionId' });
     }

     const validModes: PermissionMode[] = ['default', 'plan', 'acceptEdits', 'bypassPermissions'];
     if (!validModes.includes(mode)) {
       return res.status(400).json({ error: 'Invalid mode', validModes });
     }

     setSessionMode(sessionId, mode);

     // Send SSE event to client if connection exists
     const connection = activeConnections.get(/* need to map sessionId to connectionId */);
     // For now, just confirm mode change - SSE notification is optional enhancement

     res.json({ success: true, mode });
   });
   ```

5. Update /stream endpoint to:
   - Read initial mode from query params
   - Store session mode when session_id is received from SDK init message
   - Pass mode to streamAgentQuery options

6. Clean up session mode on connection close
  </action>
  <verify>
1. Server builds: `cd apps/claude-code-web/server && pnpm build`
2. Server starts: `cd apps/claude-code-web/server && timeout 5 pnpm dev || true`
  </verify>
  <done>POST /api/agent/mode endpoint changes session permission mode and validates input</done>
</task>

<task type="auto">
  <name>Task 2: Create ModeSelector component</name>
  <files>
    apps/claude-code-web/client/src/components/ModeSelector.tsx
    apps/claude-code-web/client/src/components/ModeSelector.module.css
  </files>
  <action>
**Create ModeSelector.tsx:**

1. Import Segmented, Tooltip from @ui-kit/react
2. Import icons from @ui-kit/icons (ShieldIcon, MapIcon, EditIcon, BoltIcon or similar)
3. Import PermissionMode type from '../types/agent'

4. Props interface:
   ```typescript
   interface ModeSelectorProps {
     mode: PermissionMode;
     onChange: (mode: PermissionMode) => void;
     disabled?: boolean;
   }
   ```

5. Define mode metadata:
   ```typescript
   const MODE_INFO: Record<PermissionMode, { label: string; icon: React.ReactNode; description: string }> = {
     default: {
       label: 'Default',
       icon: <ShieldIcon size="sm" />,
       description: 'Prompts for tool approval',
     },
     plan: {
       label: 'Plan',
       icon: <MapIcon size="sm" />,
       description: 'Read-only mode, no execution',
     },
     acceptEdits: {
       label: 'Accept Edits',
       icon: <EditIcon size="sm" />,
       description: 'Auto-approves file modifications',
     },
     bypassPermissions: {
       label: 'Auto',
       icon: <BoltIcon size="sm" />,
       description: 'Auto-approves all tools (use with caution)',
     },
   };
   ```
   Note: Check @ui-kit/icons for actual available icon names and adjust accordingly.

6. Implement component:
   - Build options array from MODE_INFO
   - Handle mode change with confirmation for bypassPermissions:
     ```typescript
     const handleChange = (newMode: string) => {
       if (newMode === 'bypassPermissions') {
         // Use a simple confirm dialog - will be replaced with proper Dialog in future
         const confirmed = window.confirm(
           'Auto mode bypasses all permission checks. Claude will execute commands without asking. Continue?'
         );
         if (!confirmed) return;
       }
       onChange(newMode as PermissionMode);
     };
     ```
   - Render Segmented with options, value={mode}, onChange={handleChange}, disabled={disabled}
   - Wrap in Tooltip showing current mode description

**Create ModeSelector.module.css:**

Style the mode selector:
- .container: flex container with proper alignment
- Ensure icons display correctly in segmented buttons
  </action>
  <verify>Build passes: `cd apps/claude-code-web/client && pnpm build`</verify>
  <done>ModeSelector component renders Segmented control with four mode options and confirmation for bypassPermissions</done>
</task>

<task type="auto">
  <name>Task 3: Integrate ModeSelector into ChatView</name>
  <files>
    apps/claude-code-web/client/src/hooks/useAgentStream.ts
    apps/claude-code-web/client/src/components/ChatView.tsx
  </files>
  <action>
**Update useAgentStream.ts:**

1. Add setPermissionMode function that:
   - Updates local state
   - POSTs to /api/agent/mode if sessionId exists
   ```typescript
   const changePermissionMode = async (newMode: PermissionMode) => {
     setPermissionMode(newMode);
     if (sessionId) {
       try {
         await fetch('/api/agent/mode', {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' },
           body: JSON.stringify({ sessionId, mode: newMode }),
         });
       } catch (error) {
         console.error('Failed to change mode:', error);
       }
     }
   };
   ```

2. Return changePermissionMode from the hook

3. Update UseAgentStreamReturn interface to include changePermissionMode

**Update ChatView.tsx:**

1. Import ModeSelector component
2. Destructure from useConversation/useAgentStream:
   - permissionMode
   - changePermissionMode
   - permissionRequest (to check if dialog is open)

3. Add ModeSelector to the header/toolbar area of ChatView:
   - Position it near the context usage indicator or in a logical toolbar location
   - Pass disabled={!!permissionRequest} to disable while permission dialog is open
   ```tsx
   <ModeSelector
     mode={permissionMode}
     onChange={changePermissionMode}
     disabled={!!permissionRequest || !!questionRequest}
   />
   ```

4. Consider adding a subtle indicator when in non-default mode:
   - Plan mode: show "Read-only" badge
   - bypassPermissions: show warning indicator
  </action>
  <verify>
1. Build passes: `cd apps/claude-code-web/client && pnpm build`
2. Dev server starts: `cd apps/claude-code-web/client && timeout 5 pnpm dev || true`
  </verify>
  <done>
- ModeSelector integrated into ChatView header
- Mode changes POST to server
- Selector disabled while permission dialog is open
- bypassPermissions shows confirmation warning
  </done>
</task>

</tasks>

<verification>
1. Client and server both build without errors
2. ModeSelector renders with four mode options
3. Mode change POSTs to /api/agent/mode endpoint
4. bypassPermissions mode shows confirmation dialog
5. ModeSelector is disabled when permission dialog is open
</verification>

<success_criteria>
- Mode indicator shows current execution mode in ChatView
- User can switch between default/plan/acceptEdits/bypassPermissions
- Plan mode is passed to server and restricts operations
- bypassPermissions mode shows warning before activation
- Mode selector disabled during permission prompts
- Mode changes persist for the session
</success_criteria>

<output>
After completion, create `.planning/phases/04-permissions-modes/04-03-SUMMARY.md`
</output>
