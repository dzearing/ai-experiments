---
phase: 02-core-streaming
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - apps/claude-code-web/client/src/components/ChatView.tsx
  - apps/claude-code-web/client/src/components/ChatView.module.css
  - apps/claude-code-web/client/src/components/ContextUsage.tsx
  - apps/claude-code-web/client/src/components/ContextUsage.module.css
  - apps/claude-code-web/client/src/components/WelcomeMessage.tsx
  - apps/claude-code-web/client/src/components/WelcomeMessage.module.css
autonomous: false

must_haves:
  truths:
    - "User can send a message and see streaming response token by token"
    - "Thinking blocks display during extended reasoning"
    - "Multi-turn conversation maintains context across messages"
    - "Markdown renders with syntax highlighting and copy buttons"
    - "Context usage indicator shows token consumption"
  artifacts:
    - path: "apps/claude-code-web/client/src/components/ChatView.tsx"
      provides: "Main chat interface using ChatPanel"
      min_lines: 80
    - path: "apps/claude-code-web/client/src/components/ContextUsage.tsx"
      provides: "Token usage progress indicator"
      exports: ["ContextUsage"]
    - path: "apps/claude-code-web/client/src/components/WelcomeMessage.tsx"
      provides: "Empty state welcome message"
      exports: ["WelcomeMessage"]
  key_links:
    - from: "apps/claude-code-web/client/src/components/ChatView.tsx"
      to: "apps/claude-code-web/client/src/hooks/useConversation.ts"
      via: "hook consumption"
      pattern: "useConversation"
    - from: "apps/claude-code-web/client/src/components/ChatView.tsx"
      to: "@ui-kit/react-chat"
      via: "ChatPanel, ChatInput, ThinkingIndicator imports"
      pattern: "ChatPanel|ChatInput|ThinkingIndicator"
---

<objective>
Build the chat UI that displays streaming conversations with Claude.

Purpose: Provide a complete chat interface where users can send messages and see Claude's streaming responses with markdown rendering, thinking indicators, and context usage tracking.

Output: Functional chat view with streaming message display, input handling, and status indicators.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-streaming/02-RESEARCH.md
@.planning/phases/02-core-streaming/02-01-SUMMARY.md
@.planning/phases/02-core-streaming/02-02-SUMMARY.md
@apps/claude-code-web/client/src/components/ChatView.tsx
@packages/ui-kit/react-chat/src/components/ChatPanel/ChatPanel.tsx
@packages/ui-kit/react-chat/src/components/ChatInput/ChatInput.tsx
@packages/ui-kit/react-chat/src/components/ThinkingIndicator/ThinkingIndicator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create supporting components</name>
  <files>
    apps/claude-code-web/client/src/components/ContextUsage.tsx
    apps/claude-code-web/client/src/components/ContextUsage.module.css
    apps/claude-code-web/client/src/components/WelcomeMessage.tsx
    apps/claude-code-web/client/src/components/WelcomeMessage.module.css
  </files>
  <action>
**Part A: Create ContextUsage component**

Create apps/claude-code-web/client/src/components/ContextUsage.tsx:

```typescript
import type { UsageStats } from '../types/agent';
import styles from './ContextUsage.module.css';

interface ContextUsageProps {
  usage: UsageStats | null;
  maxTokens?: number; // Default 200000 for Claude
  className?: string;
}

export function ContextUsage({ usage, maxTokens = 200000, className }: ContextUsageProps) {
  // Component implementation
}
```

Features:
- Display "X / 200k tokens" format
- Progress bar showing percentage used
- Color changes: green (<50%), yellow (50-80%), red (>80%)
- Graceful null handling (show "-- / 200k" when no usage)
- Use design tokens from CLAUDE.md guidance

Create ContextUsage.module.css:
- Progress bar container with background
- Progress fill with transition animation
- Text display with appropriate font size
- Color states for different usage levels

**Part B: Create WelcomeMessage component**

Create apps/claude-code-web/client/src/components/WelcomeMessage.tsx:

```typescript
import styles from './WelcomeMessage.module.css';

export function WelcomeMessage() {
  // Friendly empty state for chat
}
```

Features:
- Welcome text: "Claude Code Web"
- Subtitle: "Ask me anything about code, files, or projects"
- Optionally show keyboard shortcut hints
- Clean, centered layout
- Use design tokens

Create WelcomeMessage.module.css:
- Centered flex container
- Typography using design tokens
- Subtle, non-intrusive styling
  </action>
  <verify>
Run: `cd /Users/dzearing/git/ai-exp-3/apps/claude-code-web/client && pnpm tsc --noEmit`
Components compile without errors.
  </verify>
  <done>
ContextUsage and WelcomeMessage components created with proper styling
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor ChatView to use ui-kit components</name>
  <files>
    apps/claude-code-web/client/src/components/ChatView.tsx
    apps/claude-code-web/client/src/components/ChatView.module.css
  </files>
  <action>
Completely refactor ChatView to use proper chat components:

1. Replace imports:
   - Remove old Button, Input imports
   - Add: ChatPanel, ChatInput, ThinkingIndicator from @ui-kit/react-chat
   - Add: useConversation from hooks
   - Add: ContextUsage, WelcomeMessage from local components

2. Remove Phase 1 test code:
   - Remove health check logic (keep for debug panel if desired)
   - Remove raw message display
   - Remove manual SSE connection management

3. Use useConversation hook:
   ```typescript
   const {
     messages,
     isStreaming,
     isThinking,
     thinkingContent,
     contextUsage,
     error,
     sendMessage,
     clearConversation,
   } = useConversation();
   ```

4. Structure the component:
   ```tsx
   <div className={styles.chatView}>
     {/* Header with context usage */}
     <header className={styles.header}>
       <h1>Claude Code Web</h1>
       <ContextUsage usage={contextUsage} />
     </header>

     {/* Main chat area */}
     <main className={styles.chatArea}>
       <ChatPanel
         messages={messages}
         isLoading={isStreaming && !isThinking}
         loadingText="Claude is responding..."
         autoScroll={true}
         emptyState={<WelcomeMessage />}
       />

       {/* Thinking indicator - positioned above input */}
       {isThinking && (
         <ThinkingIndicator
           isActive={true}
           statusText={thinkingContent ? 'Deep thinking...' : undefined}
           showEscapeHint={true}
         />
       )}

       {/* Error display */}
       {error && (
         <div className={styles.error}>{error}</div>
       )}
     </main>

     {/* Input area */}
     <footer className={styles.inputArea}>
       <ChatInput
         onSubmit={(data) => sendMessage(data.content)}
         disabled={isStreaming}
         placeholder="Message Claude..."
         autoFocus={true}
       />
     </footer>
   </div>
   ```

5. Handle input submission:
   - ChatInput's onSubmit provides ChatInputSubmitData
   - Extract content and call sendMessage(content)
   - Input clears automatically via ChatInput

6. Update ChatView.module.css:
   - Full-height flex layout
   - Header fixed at top with context indicator
   - Chat area fills remaining space with scroll
   - Input fixed at bottom
   - Use design tokens from CLAUDE.md (--color-body-*, --spacing-*, etc.)
   - Ensure proper z-indexing for fixed elements
  </action>
  <verify>
Run: `cd /Users/dzearing/git/ai-exp-3/apps/claude-code-web/client && pnpm tsc --noEmit`
Component compiles. All imports resolve.
  </verify>
  <done>
ChatView uses ChatPanel, ChatInput, ThinkingIndicator with proper layout and state management
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete streaming chat interface with:
- ChatPanel displaying messages with markdown rendering
- ChatInput for composing messages
- ThinkingIndicator during extended reasoning
- ContextUsage showing token consumption
- WelcomeMessage empty state
  </what-built>
  <how-to-verify>
1. Start the server: `cd apps/claude-code-web/server && pnpm dev`
2. Start the client: `cd apps/claude-code-web/client && pnpm dev`
3. Open http://localhost:5174

**Test streaming:**
- Type a message like "What is TypeScript?" and press Enter
- Verify: Response appears token by token (not all at once)
- Verify: Markdown formatting works (if Claude uses code blocks or lists)

**Test multi-turn:**
- Send a follow-up message like "Can you give an example?"
- Verify: Claude remembers context from first message

**Test thinking indicator:**
- Ask a complex question that might trigger extended thinking
- Verify: ThinkingIndicator appears during processing

**Test context usage:**
- Send several messages
- Verify: Token count in header updates after each response

**Test UI layout:**
- Verify: Messages scroll properly
- Verify: Input stays at bottom
- Verify: Empty state shows welcome message initially
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Full build passes: `cd apps/claude-code-web && pnpm build`
2. Both server and client start without errors
3. SSE connection established when sending message
4. Messages display with proper formatting
5. Thinking indicator shows during processing
6. Context usage updates after responses
</verification>

<success_criteria>
- User can send message and see streaming response token by token
- Thinking blocks display during extended reasoning
- Multi-turn conversation maintains context
- Markdown renders with syntax highlighting
- Context usage indicator shows token consumption
- UI is responsive and properly laid out
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-streaming/02-03-SUMMARY.md`
</output>
