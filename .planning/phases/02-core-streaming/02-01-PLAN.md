---
phase: 02-core-streaming
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/claude-code-web/server/src/routes/agent.ts
  - apps/claude-code-web/server/src/services/agentService.ts
  - apps/claude-code-web/server/src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Server streams SDK messages to client via SSE"
    - "Session ID captured from init message and returned to client"
    - "Partial messages include token-by-token text deltas"
    - "Result message ends the stream with usage statistics"
  artifacts:
    - path: "apps/claude-code-web/server/src/routes/agent.ts"
      provides: "SSE endpoint with real SDK query() calls"
      contains: "query("
    - path: "apps/claude-code-web/server/src/services/agentService.ts"
      provides: "Agent SDK wrapper with streaming iterator"
      exports: ["streamAgentQuery"]
    - path: "apps/claude-code-web/server/src/types/index.ts"
      provides: "SDK message type definitions"
      contains: "SDKMessage"
  key_links:
    - from: "apps/claude-code-web/server/src/routes/agent.ts"
      to: "apps/claude-code-web/server/src/services/agentService.ts"
      via: "import streamAgentQuery"
      pattern: "streamAgentQuery"
    - from: "apps/claude-code-web/server/src/services/agentService.ts"
      to: "@anthropic-ai/claude-agent-sdk"
      via: "query() function call"
      pattern: "query\\("
---

<objective>
Replace the Phase 1 test SSE endpoint with real Agent SDK streaming.

Purpose: Enable the server to forward actual Claude responses token-by-token to the client, including session management for multi-turn conversations.

Output: Working SSE endpoint that streams SDK messages (system init, partial text, assistant, result) to connected clients.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-streaming/02-RESEARCH.md
@apps/claude-code-web/server/src/routes/agent.ts
@apps/claude-code-web/server/src/services/agentService.ts
@apps/claude-code-web/server/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define SDK message types</name>
  <files>apps/claude-code-web/server/src/types/index.ts</files>
  <action>
Add comprehensive SDK message type definitions based on Agent SDK documentation:

1. Add SDKMessage union type covering all message types:
   - SDKSystemMessage (subtype: 'init' with session_id)
   - SDKAssistantMessage (with content blocks: text, tool_use, thinking)
   - SDKPartialAssistantMessage (with RawMessageStreamEvent for deltas)
   - SDKResultMessage (with usage statistics)
   - SDKErrorMessage

2. Add content block types:
   - TextBlock { type: 'text', text: string }
   - ThinkingBlock { type: 'thinking', thinking: string }
   - ToolUseBlock { type: 'tool_use', id: string, name: string, input: object }

3. Add usage statistics type:
   - UsageStats { input_tokens: number, output_tokens: number }

Keep existing AgentQueryOptions and HealthResponse. Export all new types.
  </action>
  <verify>
Run: `cd /Users/dzearing/git/ai-exp-3/apps/claude-code-web/server && pnpm tsc --noEmit`
No type errors in types/index.ts
  </verify>
  <done>
SDK message types exported from types/index.ts, TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Agent SDK streaming service</name>
  <files>apps/claude-code-web/server/src/services/agentService.ts</files>
  <action>
Replace placeholder queryAgent with real streaming implementation:

1. Import query from @anthropic-ai/claude-agent-sdk (if not available, log warning and use mock)

2. Create streamAgentQuery async generator function:
   ```typescript
   export async function* streamAgentQuery(options: {
     prompt: string;
     sessionId?: string;
     cwd?: string;
   }): AsyncGenerator<SDKMessage>
   ```

3. Inside streamAgentQuery:
   - Call query() with:
     - prompt from options
     - options.resume = sessionId (if provided)
     - options.includePartialMessages = true
     - options.permissionMode = 'bypassPermissions' (for Phase 2 simplicity)
   - Yield each message from the query iterator
   - Catch errors and yield SDKErrorMessage

4. Keep checkClaudeAvailable function as-is

5. Add fallback mock mode if SDK import fails:
   - Log warning about SDK not available
   - Return mock messages for testing (system init, partial text, assistant, result)

Note: The Agent SDK may not be installed yet. Check if it exists, if not the service should gracefully fallback to mock streaming.
  </action>
  <verify>
Run: `cd /Users/dzearing/git/ai-exp-3/apps/claude-code-web/server && pnpm tsc --noEmit`
No type errors. Function streamAgentQuery exported.
  </verify>
  <done>
streamAgentQuery function implemented with SDK integration (or mock fallback), TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire SSE endpoint to SDK streaming</name>
  <files>apps/claude-code-web/server/src/routes/agent.ts</files>
  <action>
Refactor the /stream endpoint to use real SDK streaming:

1. Import streamAgentQuery from agentService

2. Accept query parameters:
   - prompt (required): User message
   - sessionId (optional): Session to resume for multi-turn

3. Replace the test message logic with:
   ```typescript
   try {
     for await (const message of streamAgentQuery({ prompt, sessionId })) {
       res.write(`data: ${JSON.stringify(message)}\n\n`);

       // End stream on result message
       if (message.type === 'result') {
         res.end();
         return;
       }
     }
   } catch (error) {
     res.write(`data: ${JSON.stringify({ type: 'error', error: String(error) })}\n\n`);
     res.end();
   }
   ```

4. Keep existing:
   - SSE headers (Content-Type, Cache-Control, Connection, X-Accel-Buffering)
   - Heartbeat mechanism (30 second interval)
   - Connection tracking for cleanup
   - /connections monitoring endpoint

5. Handle missing prompt with 400 error response (before starting SSE)
  </action>
  <verify>
Run: `cd /Users/dzearing/git/ai-exp-3/apps/claude-code-web/server && pnpm tsc --noEmit`
TypeScript compiles.

Manual test (if server running):
`curl "http://localhost:3002/api/agent/stream?prompt=hello"`
Should return SSE events with SDK message structure (or mock messages if SDK unavailable)
  </verify>
  <done>
SSE endpoint streams SDK messages (or mock fallback), handles session resumption, validates required parameters
  </done>
</task>

</tasks>

<verification>
1. TypeScript builds without errors: `cd apps/claude-code-web/server && pnpm build`
2. Server starts without errors: `cd apps/claude-code-web/server && pnpm dev`
3. SSE endpoint responds with proper message structure when called
4. Session ID is present in system init messages
</verification>

<success_criteria>
- Server compiles and starts without errors
- /api/agent/stream accepts prompt and optional sessionId
- Messages streamed follow SDK message type structure
- Result message includes usage statistics (even if mock: { input_tokens: 0, output_tokens: 0 })
- Error handling returns structured error messages
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-streaming/02-01-SUMMARY.md`
</output>
