---
phase: 02-core-streaming
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/claude-code-web/client/src/types/agent.ts
  - apps/claude-code-web/client/src/utils/messageTransformer.ts
  - apps/claude-code-web/client/src/hooks/useAgentStream.ts
  - apps/claude-code-web/client/src/hooks/useConversation.ts
autonomous: true

must_haves:
  truths:
    - "SDK messages transform to ChatPanelMessage format"
    - "Partial messages accumulate text token-by-token"
    - "Session ID captured and reused for follow-up messages"
    - "Thinking blocks tracked separately from text content"
    - "Context usage extracted from result messages"
  artifacts:
    - path: "apps/claude-code-web/client/src/types/agent.ts"
      provides: "Client-side SDK message types"
      contains: "SDKMessage"
    - path: "apps/claude-code-web/client/src/utils/messageTransformer.ts"
      provides: "SDK to ChatPanelMessage transformation"
      exports: ["transformSDKMessage", "accumulatePartialMessage"]
    - path: "apps/claude-code-web/client/src/hooks/useAgentStream.ts"
      provides: "Enhanced SSE hook with streaming state"
      exports: ["useAgentStream"]
    - path: "apps/claude-code-web/client/src/hooks/useConversation.ts"
      provides: "Multi-turn conversation state management"
      exports: ["useConversation"]
  key_links:
    - from: "apps/claude-code-web/client/src/hooks/useAgentStream.ts"
      to: "apps/claude-code-web/client/src/utils/messageTransformer.ts"
      via: "import transform functions"
      pattern: "transformSDKMessage|accumulatePartialMessage"
    - from: "apps/claude-code-web/client/src/hooks/useConversation.ts"
      to: "apps/claude-code-web/client/src/hooks/useAgentStream.ts"
      via: "uses stream hook"
      pattern: "useAgentStream"
---

<objective>
Build client-side message transformation and conversation management layer.

Purpose: Convert SDK messages into UI-ready format (ChatPanelMessage) and manage multi-turn conversation state including session persistence, thinking block tracking, and context usage.

Output: Hooks and utilities that transform streaming SDK messages into displayable chat messages with proper state management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-streaming/02-RESEARCH.md
@apps/claude-code-web/client/src/types/agent.ts
@apps/claude-code-web/client/src/hooks/useAgentStream.ts
@packages/ui-kit/react-chat/src/components/ChatPanel/ChatPanel.tsx
@packages/ui-kit/react-chat/src/components/ChatMessage/ChatMessage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define client-side SDK types and transformer</name>
  <files>
    apps/claude-code-web/client/src/types/agent.ts
    apps/claude-code-web/client/src/utils/messageTransformer.ts
  </files>
  <action>
**Part A: Update types/agent.ts**

Replace simplified Phase 1 types with full SDK message types:

1. SDKMessage union type:
   - SDKSystemMessage { type: 'system', subtype: 'init', session_id: string }
   - SDKAssistantMessage { type: 'assistant', uuid: string, message: { content: ContentBlock[] } }
   - SDKPartialAssistantMessage { type: 'assistant', subtype: 'partial', uuid: string, event: RawMessageStreamEvent }
   - SDKResultMessage { type: 'result', uuid: string, is_error: boolean, usage?: UsageStats }
   - SDKErrorMessage { type: 'error', error: string }

2. ContentBlock union:
   - TextBlock { type: 'text', text: string }
   - ThinkingBlock { type: 'thinking', thinking: string }
   - ToolUseBlock { type: 'tool_use', id: string, name: string, input: Record<string, unknown> }

3. RawMessageStreamEvent (simplified for text streaming):
   - type: 'message_start' | 'content_block_start' | 'content_block_delta' | 'content_block_stop' | 'message_stop'
   - delta?: { type: 'text_delta', text: string } | { type: 'thinking_delta', thinking: string }
   - index?: number (content block index)

4. UsageStats { input_tokens: number, output_tokens: number }

5. Update UseAgentStreamReturn to include:
   - sessionId: string | null
   - isThinking: boolean
   - thinkingContent: string
   - contextUsage: UsageStats | null

**Part B: Create utils/messageTransformer.ts**

Create new file with transformation utilities:

1. Import ChatPanelMessage, ChatMessagePart from @ui-kit/react-chat

2. StreamingState interface:
   ```typescript
   interface StreamingState {
     currentMessageId: string | null;
     currentText: string;
     currentThinking: string;
     contentBlocks: ContentBlock[];
   }
   ```

3. transformSDKMessage function:
   - Takes SDKAssistantMessage
   - Returns ChatPanelMessage with:
     - id from uuid
     - content: '' (use parts instead)
     - parts: transform content blocks to ChatMessagePart[]
     - timestamp: new Date()
     - senderName: 'Claude'
     - isOwn: false
     - isStreaming: false
     - renderMarkdown: true

4. accumulatePartialMessage function:
   - Takes StreamingState and SDKPartialAssistantMessage
   - Returns updated StreamingState
   - Handle text_delta: append to currentText
   - Handle thinking_delta: append to currentThinking
   - Handle message_start: reset state with new uuid

5. createStreamingMessage function:
   - Takes StreamingState
   - Returns ChatPanelMessage with isStreaming: true
   - Text from currentText, handle empty gracefully

6. transformContentBlockToPart function:
   - TextBlock -> { type: 'text', text }
   - ThinkingBlock -> skip (tracked separately)
   - ToolUseBlock -> { type: 'tool_calls', calls: [{ name, input, completed: false }] }
  </action>
  <verify>
Run: `cd /Users/dzearing/git/ai-exp-3/apps/claude-code-web/client && pnpm tsc --noEmit`
No type errors. Types and transformer functions compile.
  </verify>
  <done>
SDK message types defined, message transformer utilities created with proper ChatPanelMessage output
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance useAgentStream hook</name>
  <files>apps/claude-code-web/client/src/hooks/useAgentStream.ts</files>
  <action>
Refactor useAgentStream to handle real SDK message streaming:

1. Import new types (SDKMessage, UsageStats) and transformer functions

2. Add new state:
   - sessionId: string | null (captured from system init)
   - isThinking: boolean (true when thinking block active)
   - thinkingContent: string (accumulated thinking text)
   - contextUsage: UsageStats | null (from result message)
   - streamingState: StreamingState (internal, for accumulation)

3. Refactor startStream(prompt: string):
   - Accept optional sessionId parameter for multi-turn
   - URL: `/api/agent/stream?prompt=${prompt}&sessionId=${sessionId || ''}`
   - Reset streamingState on start

4. Refactor onmessage handler:
   - Parse message as SDKMessage
   - Switch on message.type:

   **'system' (subtype 'init')**:
   - Capture session_id -> setSessionId

   **'assistant' (no subtype = complete message)**:
   - Transform with transformSDKMessage
   - Add to messages array
   - Clear streamingState

   **'assistant' (subtype 'partial')**:
   - Call accumulatePartialMessage with current state
   - Update or create streaming message in messages array
   - Set isThinking based on thinking_delta presence

   **'result'**:
   - Extract usage stats -> setContextUsage
   - Set isStreaming false
   - Clear thinking state

   **'error'**:
   - Set error state

5. Add clearConversation function:
   - Clears messages, sessionId, contextUsage
   - Allows starting fresh conversation

6. Update return type to match enhanced UseAgentStreamReturn
  </action>
  <verify>
Run: `cd /Users/dzearing/git/ai-exp-3/apps/claude-code-web/client && pnpm tsc --noEmit`
No type errors. Hook compiles with new functionality.
  </verify>
  <done>
useAgentStream handles SDK message types, accumulates partial messages, tracks session and thinking state
  </done>
</task>

<task type="auto">
  <name>Task 3: Create useConversation hook</name>
  <files>apps/claude-code-web/client/src/hooks/useConversation.ts</files>
  <action>
Create new hook that wraps useAgentStream with conversation-level logic:

1. Import useAgentStream, ChatPanelMessage from types

2. useConversation hook:
   ```typescript
   export function useConversation() {
     const stream = useAgentStream();
     const [userMessages, setUserMessages] = useState<ChatPanelMessage[]>([]);
   ```

3. Combine user messages with assistant messages:
   - allMessages = interleave userMessages and stream.messages by timestamp
   - Or simpler: maintain single messages array, append user message on send

4. sendMessage function:
   - Create user ChatPanelMessage:
     ```typescript
     const userMsg: ChatPanelMessage = {
       id: `user-${Date.now()}`,
       content: '', // use parts
       parts: [{ type: 'text', text: prompt }],
       timestamp: new Date(),
       senderName: 'You',
       isOwn: true,
       renderMarkdown: true,
     };
     ```
   - Add to messages
   - Call stream.startStream(prompt, sessionId)

5. Expose from hook:
   - messages: ChatPanelMessage[] (combined user + assistant)
   - isStreaming: boolean
   - isThinking: boolean
   - thinkingContent: string
   - sessionId: string | null
   - contextUsage: UsageStats | null
   - error: string | null
   - sendMessage: (prompt: string) => void
   - clearConversation: () => void
   - interrupt: () => void (calls stopStream)

6. Handle message ordering:
   - Keep messages in chronological order
   - User message appears immediately
   - Assistant response streams in after
  </action>
  <verify>
Run: `cd /Users/dzearing/git/ai-exp-3/apps/claude-code-web/client && pnpm tsc --noEmit`
No type errors. Hook compiles and exports expected interface.
  </verify>
  <done>
useConversation hook manages full conversation state, combines user and assistant messages, provides clean API for chat UI
  </done>
</task>

</tasks>

<verification>
1. TypeScript builds: `cd apps/claude-code-web/client && pnpm build`
2. All hooks export expected functions
3. Types align with @ui-kit/react-chat ChatPanelMessage interface
4. No circular dependencies between hooks and utils
</verification>

<success_criteria>
- Client compiles without type errors
- SDKMessage types match server-side definitions
- transformSDKMessage produces valid ChatPanelMessage
- accumulatePartialMessage correctly handles text deltas
- useConversation provides clean API for UI consumption
- Session ID persists across messages in same conversation
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-streaming/02-02-SUMMARY.md`
</output>
