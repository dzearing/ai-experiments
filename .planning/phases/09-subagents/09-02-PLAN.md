---
phase: 09-subagents
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - apps/claude-code-web/client/src/types/agent.ts
  - apps/claude-code-web/client/src/utils/messageTransformer.ts
  - apps/claude-code-web/client/src/hooks/useAgentStream.ts
autonomous: true

must_haves:
  truths:
    - "Client receives and parses SubagentStart/SubagentStop SSE events"
    - "Active subagents are tracked in useAgentStream state"
    - "Messages with parent_tool_use_id are identified as subagent messages"
  artifacts:
    - path: "apps/claude-code-web/client/src/types/agent.ts"
      provides: "SubagentState type, subagent SSE event types"
      exports: ["SubagentState", "SubagentStartEvent", "SubagentStopEvent"]
    - path: "apps/claude-code-web/client/src/hooks/useAgentStream.ts"
      provides: "activeSubagents state, subagent lifecycle handlers"
      contains: "activeSubagents"
  key_links:
    - from: "useAgentStream.ts"
      to: "SSE event parsing"
      via: "handleSDKMessage switch case"
      pattern: "subagent_start"
    - from: "messageTransformer.ts"
      to: "SDKAssistantMessage"
      via: "parent_tool_use_id extraction"
      pattern: "parent_tool_use_id"
---

<objective>
Track subagent lifecycle on the client and identify subagent messages.

Purpose: Enable the client to know when subagents are running, which messages belong to subagents, and when subagents complete.

Output:
- Subagent event types in client types
- useAgentStream tracks active subagents
- Messages tagged with parent_tool_use_id are identifiable
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-subagents/09-RESEARCH.md
@apps/claude-code-web/client/src/types/agent.ts
@apps/claude-code-web/client/src/utils/messageTransformer.ts
@apps/claude-code-web/client/src/hooks/useAgentStream.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subagent types and extend SDK message types</name>
  <files>
    apps/claude-code-web/client/src/types/agent.ts
  </files>
  <action>
    1. Add subagent SSE event types (matching server-side types):
       ```typescript
       export interface SubagentStartEvent {
         type: 'subagent_start';
         agent_id: string;
         agent_type: string;
         tool_use_id?: string;
         session_id: string;
         timestamp: number;
       }

       export interface SubagentStopEvent {
         type: 'subagent_stop';
         agent_id: string;
         transcript_path: string;
         duration_ms?: number;
         timestamp: number;
       }
       ```

    2. Add SubagentState type for client-side tracking:
       ```typescript
       export interface SubagentState {
         id: string;                    // agent_id from hook
         toolUseId: string | null;      // Task tool_use_id that spawned this agent
         type: string;                  // agent_type (e.g., 'code-reviewer', 'general-purpose')
         status: 'running' | 'complete' | 'error';
         startTime: number;
         endTime?: number;
         transcriptPath?: string;
       }
       ```

    3. Extend SDKAssistantMessage to include parent_tool_use_id:
       ```typescript
       export interface SDKAssistantMessage {
         type: 'assistant';
         uuid: string;
         message: {
           content: ContentBlock[];
         };
         parent_tool_use_id?: string | null;  // Non-null if from subagent
       }
       ```

    4. Add SubagentStartEvent and SubagentStopEvent to the SDKMessage union.

    5. Add subagent fields to UseAgentStreamReturn:
       ```typescript
       activeSubagents: Map<string, SubagentState>;
       ```
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd apps/claude-code-web/client && npx tsc --noEmit
    ```
  </verify>
  <done>
    - SubagentStartEvent, SubagentStopEvent types exported
    - SubagentState type exported
    - SDKAssistantMessage extended with parent_tool_use_id
    - SDKMessage union includes subagent events
    - UseAgentStreamReturn includes activeSubagents
  </done>
</task>

<task type="auto">
  <name>Task 2: Add helper to detect subagent messages</name>
  <files>
    apps/claude-code-web/client/src/utils/messageTransformer.ts
  </files>
  <action>
    1. Add a utility function to detect subagent messages:
       ```typescript
       /**
        * Checks if an SDK message is from a subagent.
        * Messages with non-null parent_tool_use_id are from subagents.
        */
       export function isSubagentMessage(message: SDKAssistantMessage): boolean {
         return message.parent_tool_use_id !== null && message.parent_tool_use_id !== undefined;
       }

       /**
        * Extracts the parent tool_use_id from a subagent message.
        * Returns null if the message is not from a subagent.
        */
       export function getParentToolUseId(message: SDKAssistantMessage): string | null {
         return message.parent_tool_use_id ?? null;
       }
       ```

    2. Update transformSDKMessage to preserve parent_tool_use_id in the ChatPanelMessage.
       ChatPanelMessage may need extension to carry this metadata.
       Add a custom property using the message.id pattern or create a subagent data field:
       ```typescript
       // In transformSDKMessage:
       return {
         id: sdkMessage.uuid,
         content: '',
         parts,
         timestamp: new Date(),
         senderName: 'Claude',
         isOwn: false,
         isStreaming: false,
         renderMarkdown: true,
         // Custom metadata for subagent tracking
         metadata: {
           parentToolUseId: sdkMessage.parent_tool_use_id ?? null,
         },
       };
       ```

       Note: If ChatPanelMessage doesn't support custom metadata, we can track this
       separately in useAgentStream by correlating message IDs with subagent tool_use_ids.
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd apps/claude-code-web/client && npx tsc --noEmit
    ```
  </verify>
  <done>
    - isSubagentMessage helper function exported
    - getParentToolUseId helper function exported
    - transformSDKMessage preserves parent_tool_use_id information
  </done>
</task>

<task type="auto">
  <name>Task 3: Track subagent lifecycle in useAgentStream</name>
  <files>
    apps/claude-code-web/client/src/hooks/useAgentStream.ts
  </files>
  <action>
    1. Add state for tracking active subagents:
       ```typescript
       const [activeSubagents, setActiveSubagents] = useState<Map<string, SubagentState>>(new Map());
       ```

    2. Add handler for SubagentStart events in handleSDKMessage:
       ```typescript
       case 'subagent_start': {
         const event = message as SubagentStartEvent;
         setActiveSubagents(prev => {
           const next = new Map(prev);
           next.set(event.agent_id, {
             id: event.agent_id,
             toolUseId: event.tool_use_id ?? null,
             type: event.agent_type,
             status: 'running',
             startTime: event.timestamp,
           });
           return next;
         });
         break;
       }
       ```

    3. Add handler for SubagentStop events:
       ```typescript
       case 'subagent_stop': {
         const event = message as SubagentStopEvent;
         setActiveSubagents(prev => {
           const next = new Map(prev);
           const existing = next.get(event.agent_id);
           if (existing) {
             next.set(event.agent_id, {
               ...existing,
               status: 'complete',
               endTime: event.timestamp,
               transcriptPath: event.transcript_path,
             });
           }
           return next;
         });
         break;
       }
       ```

    4. Clear subagents on clearMessages:
       ```typescript
       setActiveSubagents(new Map());
       ```

    5. Include activeSubagents in the return object:
       ```typescript
       return {
         // ...existing fields
         activeSubagents,
       };
       ```

    6. Update UseAgentStreamReturn type import if needed.
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd apps/claude-code-web/client && npx tsc --noEmit
    ```
  </verify>
  <done>
    - activeSubagents state tracks running and completed subagents
    - subagent_start events add subagents to tracking
    - subagent_stop events mark subagents as complete
    - clearMessages resets subagent tracking
    - activeSubagents exposed in hook return
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd apps/claude-code-web/client && npx tsc --noEmit`
2. SubagentState, SubagentStartEvent, SubagentStopEvent types exported
3. isSubagentMessage and getParentToolUseId functions work correctly
4. useAgentStream returns activeSubagents Map
</verification>

<success_criteria>
- Client compiles without TypeScript errors
- Subagent event types match server-side types
- useAgentStream tracks subagent lifecycle via SSE events
- Helper functions correctly identify subagent messages
- activeSubagents Map accessible for UI components
</success_criteria>

<output>
After completion, create `.planning/phases/09-subagents/09-02-SUMMARY.md`
</output>
