---
phase: 09-subagents
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - apps/claude-code-web/client/src/types/agent.ts
  - apps/claude-code-web/client/src/utils/messageTransformer.ts
  - apps/claude-code-web/client/src/hooks/useAgentStream.ts
autonomous: true

must_haves:
  truths:
    - "Client receives and parses SubagentStart/SubagentStop SSE events"
    - "Active subagents are tracked in useAgentStream state"
    - "Messages with parent_tool_use_id are identified as subagent messages"
  artifacts:
    - path: "apps/claude-code-web/client/src/types/agent.ts"
      provides: "SubagentState type, subagent SSE event types"
      exports: ["SubagentState", "SubagentStartEvent", "SubagentStopEvent"]
    - path: "apps/claude-code-web/client/src/hooks/useAgentStream.ts"
      provides: "activeSubagents state, subagent lifecycle handlers"
      contains: "activeSubagents"
  key_links:
    - from: "useAgentStream.ts"
      to: "SSE event parsing"
      via: "handleSDKMessage switch case"
      pattern: "subagent_start"
    - from: "useAgentStream.ts"
      to: "message correlation"
      via: "subagentMessageMap tracking parent_tool_use_id to subagent_id"
      pattern: "subagentMessageMap"
---

<objective>
Track subagent lifecycle on the client and identify subagent messages.

Purpose: Enable the client to know when subagents are running, which messages belong to subagents, and when subagents complete.

Output:
- Subagent event types in client types
- useAgentStream tracks active subagents
- Messages tagged with parent_tool_use_id are identifiable
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-subagents/09-RESEARCH.md
@apps/claude-code-web/client/src/types/agent.ts
@apps/claude-code-web/client/src/utils/messageTransformer.ts
@apps/claude-code-web/client/src/hooks/useAgentStream.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subagent types and extend SDK message types</name>
  <files>
    apps/claude-code-web/client/src/types/agent.ts
  </files>
  <action>
    1. Add subagent SSE event types (matching server-side types):
       ```typescript
       export interface SubagentStartEvent {
         type: 'subagent_start';
         agent_id: string;
         agent_type: string;
         tool_use_id?: string;
         session_id: string;
         timestamp: number;
       }

       export interface SubagentStopEvent {
         type: 'subagent_stop';
         agent_id: string;
         transcript_path: string;
         duration_ms?: number;
         timestamp: number;
       }
       ```

    2. Add SubagentState type for client-side tracking:
       ```typescript
       export interface SubagentState {
         id: string;                    // agent_id from hook
         toolUseId: string | null;      // Task tool_use_id that spawned this agent
         type: string;                  // agent_type (e.g., 'code-reviewer', 'general-purpose')
         status: 'running' | 'complete' | 'error';
         startTime: number;
         endTime?: number;
         transcriptPath?: string;
       }
       ```

    3. Extend SDKAssistantMessage to include parent_tool_use_id:
       ```typescript
       export interface SDKAssistantMessage {
         type: 'assistant';
         uuid: string;
         message: {
           content: ContentBlock[];
         };
         parent_tool_use_id?: string | null;  // Non-null if from subagent
       }
       ```

    4. Add SubagentStartEvent and SubagentStopEvent to the SDKMessage union.

    5. Add subagent fields to UseAgentStreamReturn:
       ```typescript
       activeSubagents: Map<string, SubagentState>;
       ```
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd apps/claude-code-web/client && npx tsc --noEmit
    ```
  </verify>
  <done>
    - SubagentStartEvent, SubagentStopEvent types exported
    - SubagentState type exported
    - SDKAssistantMessage extended with parent_tool_use_id
    - SDKMessage union includes subagent events
    - UseAgentStreamReturn includes activeSubagents
  </done>
</task>

<task type="auto">
  <name>Task 2: Add helper to detect subagent messages and track correlation</name>
  <files>
    apps/claude-code-web/client/src/utils/messageTransformer.ts
  </files>
  <action>
    1. Add a utility function to detect subagent messages:
       ```typescript
       /**
        * Checks if an SDK message is from a subagent.
        * Messages with non-null parent_tool_use_id are from subagents.
        */
       export function isSubagentMessage(message: SDKAssistantMessage): boolean {
         return message.parent_tool_use_id !== null && message.parent_tool_use_id !== undefined;
       }

       /**
        * Extracts the parent tool_use_id from a subagent message.
        * Returns null if the message is not from a subagent.
        */
       export function getParentToolUseId(message: SDKAssistantMessage): string | null {
         return message.parent_tool_use_id ?? null;
       }
       ```

    2. Correlation tracking approach (implemented in useAgentStream, not messageTransformer):
       - useAgentStream maintains a `subagentMessageMap: Map<string, string>` that maps
         message UUIDs to their parent subagent IDs
       - When an assistant message with parent_tool_use_id arrives, useAgentStream:
         a. Looks up which active subagent has that toolUseId
         b. Records the mapping: messageUuid -> subagentId
       - This keeps ChatPanelMessage unchanged (no metadata field needed)
       - UI components can query subagentMessageMap to determine if a message came from a subagent

    3. Export the helper functions from messageTransformer.ts for use in useAgentStream.
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd apps/claude-code-web/client && npx tsc --noEmit
    ```
  </verify>
  <done>
    - isSubagentMessage helper function exported
    - getParentToolUseId helper function exported
    - Correlation tracking approach documented (implemented in Task 3)
  </done>
</task>

<task type="auto">
  <name>Task 3: Track subagent lifecycle in useAgentStream</name>
  <files>
    apps/claude-code-web/client/src/hooks/useAgentStream.ts
  </files>
  <action>
    1. Add state for tracking active subagents:
       ```typescript
       const [activeSubagents, setActiveSubagents] = useState<Map<string, SubagentState>>(new Map());
       ```

    2. Add ref for message-to-subagent correlation (no re-render needed):
       ```typescript
       const subagentMessageMap = useRef<Map<string, string>>(new Map());
       ```

    3. Add handler for SubagentStart events in handleSDKMessage:
       ```typescript
       case 'subagent_start': {
         const event = message as SubagentStartEvent;
         setActiveSubagents(prev => {
           const next = new Map(prev);
           next.set(event.agent_id, {
             id: event.agent_id,
             toolUseId: event.tool_use_id ?? null,
             type: event.agent_type,
             status: 'running',
             startTime: event.timestamp,
           });
           return next;
         });
         break;
       }
       ```

    4. Add handler for SubagentStop events:
       ```typescript
       case 'subagent_stop': {
         const event = message as SubagentStopEvent;
         setActiveSubagents(prev => {
           const next = new Map(prev);
           const existing = next.get(event.agent_id);
           if (existing) {
             next.set(event.agent_id, {
               ...existing,
               status: 'complete',
               endTime: event.timestamp,
               transcriptPath: event.transcript_path,
             });
           }
           return next;
         });
         break;
       }
       ```

    5. In the assistant message handler, track correlation:
       ```typescript
       case 'assistant': {
         const assistantMsg = message as SDKAssistantMessage;
         const parentToolUseId = getParentToolUseId(assistantMsg);
         if (parentToolUseId) {
           // Find which subagent has this toolUseId
           for (const [subagentId, subagent] of activeSubagents) {
             if (subagent.toolUseId === parentToolUseId) {
               subagentMessageMap.current.set(assistantMsg.uuid, subagentId);
               break;
             }
           }
         }
         // ... existing message handling
       }
       ```

    6. Clear subagents on clearMessages:
       ```typescript
       setActiveSubagents(new Map());
       subagentMessageMap.current.clear();
       ```

    7. Include activeSubagents and subagentMessageMap in the return object:
       ```typescript
       return {
         // ...existing fields
         activeSubagents,
         subagentMessageMap: subagentMessageMap.current,
       };
       ```

    8. Update UseAgentStreamReturn type import if needed.
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd apps/claude-code-web/client && npx tsc --noEmit
    ```
  </verify>
  <done>
    - activeSubagents state tracks running and completed subagents
    - subagentMessageMap tracks message-to-subagent correlation
    - subagent_start events add subagents to tracking
    - subagent_stop events mark subagents as complete
    - Assistant messages with parent_tool_use_id are correlated to subagents
    - clearMessages resets subagent tracking
    - activeSubagents and subagentMessageMap exposed in hook return
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd apps/claude-code-web/client && npx tsc --noEmit`
2. SubagentState, SubagentStartEvent, SubagentStopEvent types exported
3. isSubagentMessage and getParentToolUseId functions work correctly
4. useAgentStream returns activeSubagents Map
5. subagentMessageMap correctly correlates message UUIDs to subagent IDs
</verification>

<success_criteria>
- Client compiles without TypeScript errors
- Subagent event types match server-side types
- useAgentStream tracks subagent lifecycle via SSE events
- Helper functions correctly identify subagent messages
- activeSubagents Map accessible for UI components
- subagentMessageMap enables message-to-subagent correlation without modifying ChatPanelMessage
</success_criteria>

<output>
After completion, create `.planning/phases/09-subagents/09-02-SUMMARY.md`
</output>
