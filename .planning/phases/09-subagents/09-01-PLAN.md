---
phase: 09-subagents
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/claude-code-web/server/src/services/agentService.ts
  - apps/claude-code-web/server/src/services/configService.ts
  - apps/claude-code-web/server/src/hooks/subagentHooks.ts
  - apps/claude-code-web/server/src/routes/agent.ts
  - apps/claude-code-web/server/src/types/index.ts
autonomous: true

must_haves:
  truths:
    - "Task tool is available in SDK query options when agents are configured"
    - "Custom agents load from settings.json agents field"
    - "SubagentStart/SubagentStop hooks emit SSE events to connected clients"
  artifacts:
    - path: "apps/claude-code-web/server/src/services/agentService.ts"
      provides: "Task tool in allowedTools, agents config forwarding"
      contains: "allowedTools"
    - path: "apps/claude-code-web/server/src/hooks/subagentHooks.ts"
      provides: "SSE-emitting subagent hooks"
      exports: ["createSubagentSSEHooks"]
  key_links:
    - from: "agentService.ts"
      to: "SDK query()"
      via: "agents and allowedTools in queryOptions"
      pattern: "agents:"
    - from: "subagentHooks.ts"
      to: "SSE response"
      via: "emitSSE callback"
      pattern: "emitSSE"
---

<objective>
Enable Task tool and subagent spawning with SSE lifecycle events.

Purpose: Allow Claude to delegate tasks to subagents with isolated context, with lifecycle events streamed to the client for UI tracking.

Output:
- Server forwards Task tool and agents config to SDK
- SubagentStart/SubagentStop events sent to client via SSE
- Custom agent definitions loaded from settings.json
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-subagents/09-RESEARCH.md
@apps/claude-code-web/server/src/services/agentService.ts
@apps/claude-code-web/server/src/hooks/subagentHooks.ts
@apps/claude-code-web/server/src/services/hooksService.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subagent SSE event types and hook enhancement</name>
  <files>
    apps/claude-code-web/server/src/types/index.ts
    apps/claude-code-web/server/src/hooks/subagentHooks.ts
  </files>
  <action>
    1. In types/index.ts, add SSE event types for subagent lifecycle:
       ```typescript
       export interface SubagentStartEvent {
         type: 'subagent_start';
         agent_id: string;
         agent_type: string;
         tool_use_id?: string;  // The Task tool_use_id that spawned this agent
         session_id: string;
         timestamp: number;
       }

       export interface SubagentStopEvent {
         type: 'subagent_stop';
         agent_id: string;
         transcript_path: string;
         duration_ms?: number;
         timestamp: number;
       }
       ```
       Add these to the SDKMessage union or create a separate SubagentEvent union.

    2. In subagentHooks.ts, create a new factory that accepts an SSE emitter:
       ```typescript
       export function createSubagentSSEHooks(
         emitSSE: (event: SubagentStartEvent | SubagentStopEvent) => void
       ): { start: HookCallback; stop: HookCallback }
       ```
       - The start hook should extract agent_id, agent_type from SubagentStartHookInput and emit a subagent_start event
       - The stop hook should extract agent_id, transcript_path from SubagentStopHookInput and emit a subagent_stop event
       - Keep existing createSubagentTrackerHook for backward compatibility
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd apps/claude-code-web/server && npx tsc --noEmit
    ```
  </verify>
  <done>
    - SubagentStartEvent and SubagentStopEvent types exported from types/index.ts
    - createSubagentSSEHooks factory exported from subagentHooks.ts
    - Existing hook functions remain functional
  </done>
</task>

<task type="auto">
  <name>Task 2: Enable Task tool and agents config in agentService</name>
  <files>
    apps/claude-code-web/server/src/services/configService.ts
    apps/claude-code-web/server/src/services/agentService.ts
  </files>
  <action>
    1. In configService.ts, add AgentDefinition type and include agents parsing:
       ```typescript
       export interface AgentDefinition {
         description: string;
         prompt: string;
         tools?: string[];
         model?: 'sonnet' | 'opus' | 'haiku' | 'inherit';
       }
       ```
       The loadConfig function should extract agents from settings if present.
       Add to AppConfig interface: `agents?: Record<string, AgentDefinition>`

    2. In agentService.ts, update streamAgentQuery to:
       - Add 'Task' to allowedTools when agents are configured (or always include it for built-in agents)
       - Forward config.agents to queryOptions.agents if present
       - Accept an SSE emitter parameter for subagent hooks
       - Create subagent SSE hooks using createSubagentSSEHooks and merge with existing hooks

       Key changes in queryOptions building:
       ```typescript
       // Add Task to allowedTools (required for subagent spawning)
       queryOptions.allowedTools = [...existingTools, 'Task'];

       // Forward custom agents if configured
       if (config.agents) {
         queryOptions.agents = config.agents;
       }
       ```

       For hooks, merge subagent SSE hooks with config-defined hooks:
       - Create sdkHooks from hooksService.createHookCallbacks
       - Create subagentSSEHooks from createSubagentSSEHooks(emitSSE)
       - Merge SubagentStart and SubagentStop arrays from both
  </action>
  <verify>
    TypeScript compiles without errors:
    ```bash
    cd apps/claude-code-web/server && npx tsc --noEmit
    ```
  </verify>
  <done>
    - AgentDefinition type in configService.ts
    - config.agents populated from settings.json when present
    - streamAgentQuery includes Task in allowedTools
    - streamAgentQuery forwards agents config to SDK
    - Subagent SSE hooks integrated into query options
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire subagent SSE emission in agent route</name>
  <files>
    apps/claude-code-web/server/src/routes/agent.ts
  </files>
  <action>
    1. Create an SSE emitter function that writes subagent events to the response:
       ```typescript
       const emitSubagentEvent = (event: SubagentStartEvent | SubagentStopEvent) => {
         try {
           res.write(`data: ${JSON.stringify(event)}\n\n`);
         } catch (error) {
           console.error('[AgentRoute] Failed to emit subagent event:', error);
         }
       };
       ```

    2. Pass this emitter to streamAgentQuery in the options object:
       - Update StreamAgentOptions interface if needed to include subagentEmitter callback
       - Pass emitSubagentEvent when calling streamAgentQuery

    3. The subagent events will now flow through SSE alongside other SDK messages.

    Note: The SDK's SubagentStart/SubagentStop hooks fire automatically when Task tool spawns subagents. We're just connecting those hooks to SSE.
  </action>
  <verify>
    Server starts without errors:
    ```bash
    cd apps/claude-code-web && pnpm dev:server &
    sleep 3
    curl http://localhost:3002/api/health
    pkill -f "apps/claude-code-web/server"
    ```
  </verify>
  <done>
    - Agent route creates subagent SSE emitter
    - Emitter passed to streamAgentQuery
    - Subagent lifecycle events written to SSE stream
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd apps/claude-code-web/server && npx tsc --noEmit`
2. Server starts: `cd apps/claude-code-web && pnpm dev:server` (verify no errors in console)
3. SubagentStartEvent and SubagentStopEvent types are exported
4. createSubagentSSEHooks function is exported and callable
5. Task tool included in allowedTools when building query options
</verification>

<success_criteria>
- Server compiles and starts without errors
- Task tool is included in SDK query allowedTools
- Agents config forwards from settings.json to SDK
- SubagentStart/SubagentStop hooks emit SSE events
- All new types and functions exported correctly
</success_criteria>

<output>
After completion, create `.planning/phases/09-subagents/09-01-SUMMARY.md`
</output>
