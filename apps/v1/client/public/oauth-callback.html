<!doctype html>
<html>
  <head>
    <title>GitHub OAuth Callback</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background-color: #f5f5f5;
      }
      .container {
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="spinner"></div>
      <h2>Completing GitHub authentication...</h2>
      <p>Please wait while we complete the sign-in process.</p>
    </div>

    <script>
      // Get OAuth params from URL
      const params = new URLSearchParams(window.location.search);
      const code = params.get('code');
      const state = params.get('state');

      console.log('OAuth callback received:', {
        code: !!code,
        state: !!state,
        opener: !!window.opener,
      });

      if (code && state) {
        if (window.opener && !window.opener.closed) {
          try {
            // Send the code back to the opener window
            window.opener.postMessage(
              {
                type: 'github-oauth-callback',
                code: code,
                state: state,
              },
              window.location.origin
            );

            console.log('Message sent to opener window');

            // Update UI to show success
            document.querySelector('.container').innerHTML = `
            <h2>âœ“ Authentication successful!</h2>
            <p>This window will close automatically...</p>
          `;

            // Close this window after a short delay
            setTimeout(() => {
              window.close();
            }, 2000);
          } catch (error) {
            console.error('Error sending message:', error);
            document.querySelector('.container').innerHTML = `
            <h2>Communication Error</h2>
            <p>Unable to communicate with the main window.</p>
            <button onclick="window.close()">Close Window</button>
          `;
          }
        } else {
          // No opener window
          console.error('No opener window found');
          document.querySelector('.container').innerHTML = `
          <h2>Window Error</h2>
          <p>The main application window was closed.</p>
          <button onclick="window.close()">Close Window</button>
        `;
        }
      } else {
        // Show error if no code
        const error = params.get('error');
        const errorDescription = params.get('error_description');
        console.error('OAuth error:', error, errorDescription);

        document.querySelector('.container').innerHTML = `
        <h2>Authentication Error</h2>
        <p>${errorDescription || error || 'Unable to complete authentication. Please try again.'}</p>
        <button onclick="window.close()">Close Window</button>
      `;
      }
    </script>
  </body>
</html>
